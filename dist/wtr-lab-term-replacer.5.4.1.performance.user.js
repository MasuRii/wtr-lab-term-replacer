// ==UserScript==
// @name WTR Lab Term Replacer
// @description A modular, Webpack-powered version of the WTR Lab Term Replacer userscript.
// @version 5.4.1
// @author MasuRii
// @homepage https://github.com/MasuRii/wtr-lab-term-replacer-webpack#readme
// @supportURL https://github.com/MasuRii/wtr-lab-term-replacer-webpack/issues
// @match https://wtr-lab.com/en/novel/*/*/*
// @downloadURL https://github.com/MasuRii/wtr-lab-term-replacer-webpack#readme/raw/main/dist/wtr-lab-term-replacer.5.4.1.performance.user.js
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_listValues
// @grant GM_addStyle
// @grant GM_registerMenuCommand
// @icon https://www.google.com/s2/favicons?sz=64&domain=wtr-lab.com
// @license MIT
// @namespace http://tampermonkey.net/
// @run-at document-idle
// @updateURL https://github.com/MasuRii/wtr-lab-term-replacer-webpack#readme/raw/main/dist/wtr-lab-term-replacer.5.4.1.performance.meta.js
// ==/UserScript==

(()=>{"use strict";var e={58:(e,t)=>{function r(e,...t){e&&e.isLoggingEnabled&&console.log(...t)}function n(e,t,n=!1,a,o){const s={chapterId:e,processingTime:`${t}ms`,multiScriptEnvironment:n,activeScripts:a?a.size:0,queueSize:o?o.size:0,timestamp:(new Date).toISOString()};n&&a&&a.size>0?(s.activeScripts=Array.from(a),r(null,"WTR Term Replacer: Multi-script enhanced processing completed",s)):r(null,"WTR Term Replacer: Standard processing completed",s)}Object.defineProperty(t,"__esModule",{value:!0}),t.debounce=function(e,t){let r;return function(...n){clearTimeout(r),r=setTimeout(()=>e.apply(this,n),t)}},t.detectOtherWTRScripts=function(){const e=document.querySelectorAll("[data-smart-quotes-processed], [data-uncensor-processed], [data-auto-scroll], [data-reader-enhanced]"),t=new Set;return e.forEach(e=>{e.hasAttribute("data-smart-quotes-processed")&&t.add("Smart Quotes"),e.hasAttribute("data-uncensor-processed")&&t.add("Uncensor"),(e.hasAttribute("data-auto-scroll")||e.hasAttribute("data-reader-enhanced"))&&t.add("Reader Enhancer")}),t.size>0&&r(null,`WTR Term Replacer: Multi-script environment detected - Active scripts: ${Array.from(t).join(", ")}`),t},t.endProcessingTimer=function(e,t,a,o,s){const l=a.get(e);if(l){const i=Date.now()-l,c=o&&o.size>0;return r(null,`WTR Term Replacer: Processing timer ended for ${e}, took ${i}ms`),n(t,i,c,o,s),a.delete(e),i}return r(null,`WTR Term Replacer: Warning - processing timer for ${e} not found`),0},t.escapeRegExp=function(e){return e.replace(/[.*+?^${}()|[\]\\/]/g,"\\$&")},t.estimateContentLoadLevel=function(e){var t,r,n;const a=e.querySelectorAll("p, h1, h2, h3, h4, h5, h6, div, span"),o=Array.from(a).reduce((e,t)=>{var r;return e+((null===(r=t.textContent)||void 0===r?void 0:r.trim().length)||0)},0),s=e.querySelector('.loading, .spinner, [style*="loading"], [class*="loading"]'),l=(null===(t=e.textContent)||void 0===t?void 0:t.includes("Loading..."))||(null===(r=e.textContent)||void 0===r?void 0:r.includes("loading"))||(null===(n=e.textContent)||void 0===n?void 0:n.includes("..."));let i=Math.min(o/1e3,1);return(s||l)&&(i*=.3),Math.max(i,o>100?.5:.1)},t.getChapterIdFromUrl=function(e){const t=e.match(/(chapter-\d+)/);return t?t[1]:null},t.getNovelSlug=function(){let e=window.location.pathname.match(/novel\/\d+\/([^/]+)/);return e?e[1]:(e=window.location.pathname.match(/serie-\d+\/([^/]+)/),e?e[1]:null)},t.isContentReadyForProcessing=function(e){var t;const r=(null===(t=e.textContent)||void 0===t?void 0:t.trim().length)>100,n=!e.querySelector('.loading, .spinner, [style*="loading"], .skeleton'),a=e.offsetWidth>0&&e.offsetHeight>0,o=e.querySelector(".chapter-body")||e.querySelector("p, h1, h2, h3, h4, h5, h6");return r&&n&&a&&o},t.isElementReadyForProcessing=function(e){var t;const r=e.getBoundingClientRect(),n=r.width>0&&r.height>0,a=(null===(t=e.textContent)||void 0===t?void 0:t.trim().length)>50,o=!e.querySelector('.loading, .spinner, [style*="display: none"]');return n&&a&&o},t.log=r,t.logDOMConflict=function(e,t,n,a){r(null,`WTR Term Replacer: DOM conflict detected with ${e} script`,{timestamp:(new Date).toISOString(),sourceScript:e,element:t.tagName,elementId:t.id||"no-id",processingQueueSize:n?n.size:0,chapterId:a})},t.logProcessingWithMultiScriptContext=n,t.startProcessingTimer=function(e,t){t.set(e,Date.now())}},170:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.addTermProgrammatically=async function(e,t,r=!1){if(!e)return;const s={id:`term_${Date.now()}`,original:e.trim(),replacement:t.trim(),caseSensitive:!1,isRegex:r,wholeWord:!1};n.state.terms.some(e=>e.original===s.original&&e.replacement===s.replacement&&e.isRegex===s.isRegex)?(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Skipped adding duplicate term: ${s.original}`):(n.state.terms.push(s),await(0,a.saveTerms)(n.state.terms),(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Programmatically added term (Regex: ${r}): ${s.original} -> ${s.replacement}`),"flex"===document.querySelector(".wtr-replacer-ui").style.display&&(0,o.renderTermList)(n.state.currentSearchValue))},t.downloadJSON=g,t.handleAddTermFromSelection=function(){const e=window.getSelection().toString().trim();e&&((0,o.showUIPanel)(),(0,o.showFormView)(),document.getElementById("wtr-original").value=e,document.getElementById("wtr-replacement").focus()),document.querySelector(".wtr-add-term-float-btn").style.display="none"},t.handleDeleteSelected=async function(){(0,i.log)(n.state.globalSettings,"WTR Term Replacer: Delete selected terms started"),(0,o.showUILoader)();try{const e=[...document.querySelectorAll(".wtr-replacer-term-select:checked")].map(e=>e.dataset.id);if((0,i.log)(n.state.globalSettings,`WTR Term Replacer: Found ${e.length} terms selected for deletion: ${e.join(", ")}`),0===e.length)return(0,i.log)(n.state.globalSettings,"WTR Term Replacer: Delete cancelled - no terms selected"),void alert("No terms selected.");if(confirm(`Delete ${e.length} term(s)?`)){(0,i.log)(n.state.globalSettings,"WTR Term Replacer: User confirmed deletion, proceeding...");const t=n.state.terms.filter(t=>!e.includes(t.id));(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Deleting ${n.state.terms.length-t.length} terms, ${t.length} remaining`),await(0,a.saveTerms)(t),await(0,a.loadData)(),(0,i.log)(n.state.globalSettings,"WTR Term Replacer: Terms deleted and data reloaded"),(0,s.reprocessCurrentChapter)(),n.state.isDupMode?((0,i.log)(n.state.globalSettings,"WTR Term Replacer: Updating duplicate mode after deletion"),(0,l.updateDupModeAfterChange)()):((0,i.log)(n.state.globalSettings,"WTR Term Replacer: Refreshing term list display"),(0,o.renderTermList)(n.state.currentSearchValue))}else(0,i.log)(n.state.globalSettings,"WTR Term Replacer: Delete cancelled by user")}catch(e){(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Error during term deletion: ${e.message}`),console.error("Error during term deletion:",e)}finally{(0,o.hideUILoader)()}},t.handleDisableToggle=async function(e){n.state.settings.isDisabled=e.target.checked,await(0,a.saveSettings)(n.state.settings);const t=(()=>{const e=window.location.href.match(/(chapter-\d+)/);return e?e[1]:null})();if(!t)return;const r=`#${t} .chapter-body`,o=document.querySelector(r);o&&(n.state.settings.isDisabled?(0,c.revertAllReplacements)(o):(0,c.performReplacements)(o))},t.handleExportAll=async function(){(0,o.showUILoader)();try{const e=await GM_listValues(),t="wtr_lab_terms_",r="wtr_lab_settings_",n=e.filter(e=>e.startsWith(t)),a=e.filter(e=>e.startsWith(r)),o={formatVersion:"5.4",settings:{},terms:{}};for(const e of n){const r=e.replace(t,"");o.terms[r]=await GM_getValue(e)}for(const e of a){const t=e.replace(r,"");o.settings[t]=await GM_getValue(e)}g(o,"wtr-lab-all-terms-backup.json")}catch(e){console.error("Error exporting all terms:",e),alert("Failed to export all terms.")}finally{(0,o.hideUILoader)()}},t.handleExportCombined=async function(){(0,o.showUILoader)();try{const e={formatVersion:"5.4",settings:{[n.state.novelSlug]:n.state.settings},terms:{[n.state.novelSlug]:n.state.terms}};if(await g(e,`${n.state.novelSlug}-terms.json`),confirm('The first file (Novel Terms) has been downloaded. Please check if the download completed successfully. Click "OK" to proceed with the second download (All Terms backup), or "Cancel" to skip.')){const e=await GM_listValues(),t="wtr_lab_terms_",r="wtr_lab_settings_",n=e.filter(e=>e.startsWith(t)),a=e.filter(e=>e.startsWith(r)),o={formatVersion:"5.4",settings:{},terms:{}};for(const e of n){const r=e.replace(t,"");o.terms[r]=await GM_getValue(e)}for(const e of a){const t=e.replace(r,"");o.settings[t]=await GM_getValue(e)}await g(o,"wtr-lab-all-terms-backup.json"),alert("Both files have been successfully exported!")}else alert("Second export cancelled. Only the novel terms file was downloaded.")}catch(e){console.error("Error exporting combined terms:",e),alert("Failed to export combined terms. Please try again.")}finally{(0,o.hideUILoader)()}},t.handleExportNovel=async function(){g({formatVersion:"5.4",settings:{[n.state.novelSlug]:n.state.settings},terms:{[n.state.novelSlug]:n.state.terms}},`${n.state.novelSlug}-terms.json`)},t.handleFileImport=async function(e){(0,i.log)(n.state.globalSettings,`WTR Term Replacer: File import started, import type: ${n.state.importType}`),(0,o.showUILoader)();try{const t=e.target.files[0];if(!t)return void(0,i.log)(n.state.globalSettings,"WTR Term Replacer: No file selected for import");(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Importing file: ${t.name}, size: ${t.size} bytes, type: ${t.type}`);const r=new FileReader;r.onload=async e=>{const t=e.target.result;let r;(0,i.log)(n.state.globalSettings,`WTR Term Replacer: File content loaded, length: ${t.length} characters`);try{r=JSON.parse(t),(0,i.log)(n.state.globalSettings,"WTR Term Replacer: JSON parsed successfully")}catch(e){return(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Import failed - invalid JSON: ${e.message}`),void alert("Import failed. Invalid JSON data. Error: "+e.message)}let c,d,g=!!r.formatVersion,u=Array.isArray(r),p=!g&&!u&&"object"==typeof r;if((0,i.log)(n.state.globalSettings,`WTR Term Replacer: Detected format - isNewFormat: ${g}, isArrayData: ${u}, isOldGlobal: ${p}`),u)c={[n.state.novelSlug]:r},(0,i.log)(n.state.globalSettings,"WTR Term Replacer: Array format detected, mapping to current novel");else if(p)c=r,(0,i.log)(n.state.globalSettings,"WTR Term Replacer: Old global format detected");else{if(!g)return(0,i.log)(n.state.globalSettings,"WTR Term Replacer: Import failed - unrecognized data format"),void alert("Import failed. Unrecognized data format.");c=r.terms||{},d=r.settings||{},(0,i.log)(n.state.globalSettings,`WTR Term Replacer: New format detected - terms: ${Object.keys(c).length} slugs, settings: ${Object.keys(d).length} slugs`)}let m=Object.keys(c);(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Found data for ${m.length} slugs: ${m.join(", ")}`),"novel"===n.state.importType&&m.length>1&&((0,i.log)(n.state.globalSettings,"WTR Term Replacer: Novel import with multiple slugs - warning user"),alert("Warning: File contains data for multiple novels, but importing to current novel only. Use Global Import for all."),c={[n.state.novelSlug]:c[Object.keys(c)[0]]||[]},d&&(d={[n.state.novelSlug]:d[Object.keys(d)[0]]||{}}),m=[n.state.novelSlug]);let b=!1;d&&Object.keys(d).length>0&&((0,i.log)(n.state.globalSettings,"WTR Term Replacer: Settings detected in import, asking user for confirmation"),b=confirm("This file contains settings. Would you like to import and overwrite your current settings?"));let h=0,f=0,w=0,v=0,T=0;(0,i.log)(n.state.globalSettings,"WTR Term Replacer: Starting term import process...");for(const e of m){(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Processing import for slug: ${e}`);let t=await GM_getValue(`wtr_lab_terms_${e}`,[]);(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Existing terms for ${e}: ${t.length}`);let r=!0;if(t.length>0&&((0,i.log)(n.state.globalSettings,`WTR Term Replacer: Existing terms found for ${e}, asking user about merge vs overwrite`),r=!confirm(`An existing term list was found for ${e}. Would you like to merge? (OK = Merge, Cancel = Overwrite)`),!r)){if(!confirm("Are you sure you want to overwrite?")){(0,i.log)(n.state.globalSettings,`WTR Term Replacer: User cancelled overwrite for ${e}`);continue}r=!0}let o=c[e]||[];if((0,i.log)(n.state.globalSettings,`WTR Term Replacer: Raw terms for ${e}: ${o.length}`),!Array.isArray(o)){(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Skipping ${e} - not an array`);continue}let s=o.filter(e=>{var t;if(e.wholeWord=null!==(t=e.wholeWord)&&void 0!==t&&t,e.isRegex)try{return new RegExp(e.original),T++,!0}catch(t){return v++,(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Skipping invalid regex term: "${e.original}" - ${t.message}`),console.warn(`Skipping invalid regex term on import: "${e.original}"`),!1}return T++,!0});(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Validated terms for ${e}: ${s.length} valid, ${v} invalid`);const{added:l,skipped:d,conflicts:g}=await(0,a.processAndSaveTerms)(e,s,r);h+=l,f+=d,w+=g,(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Import results for ${e} - added: ${l}, skipped: ${d}, conflicts: ${g}`)}b&&((0,i.log)(n.state.globalSettings,"WTR Term Replacer: Importing settings data..."),await(0,a.processAndSaveSettings)(d)),(0,i.log)(n.state.globalSettings,"WTR Term Replacer: Reloading data and reprocessing chapters..."),await(0,a.loadData)(),(0,s.reprocessCurrentChapter)(),(0,o.renderTermList)(n.state.currentSearchValue),n.state.isDupMode&&(0,l.updateDupModeAfterChange)();let y="Import successful!";(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Import completed - totalAdded: ${h}, totalSkipped: ${f}, totalConflicts: ${w}, invalidCount: ${v}, validCount: ${T}`),(h>0||f>0||w>0)&&(y+=`\n${h} new terms added. ${f} duplicates skipped. ${w} conflicts skipped.`),v>0&&(y+=`\n${T} terms imported. ${v} terms skipped due to invalid regex.`),alert(y)},r.readAsText(t),e.target.value="",(0,i.log)(n.state.globalSettings,"WTR Term Replacer: File import process initiated")}catch(e){(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Import error: ${e.message}`),alert("An error occurred during import."),console.error(e)}finally{(0,o.hideUILoader)()}},t.handleFindDuplicates=async function(){(0,o.showUILoader)();try{const e=`wtr_lab_terms_${n.state.novelSlug}`,t=await GM_getValue(e,[]);if((0,l.computeDupGroups)(t),0===n.state.dupKeys.length)return void alert("No duplicates found.");n.state.isDupMode=!0,n.state.currentDupIndex=0,n.state.currentSearchValue="",u("")}finally{(0,o.hideUILoader)()}},t.handleListInteraction=function(e){var t;const r=null===(t=e.target.closest("li"))||void 0===t?void 0:t.dataset.id;if(r&&e.target.classList.contains("wtr-edit-btn")){const e=n.state.terms.find(e=>e.id===r);e&&(0,o.showFormView)(e)}},t.handleSaveTerm=async function(){(0,i.log)(n.state.globalSettings,"WTR Term Replacer: Handle save term started");const e=document.getElementById("wtr-term-id").value,t=document.getElementById("wtr-original"),r=document.getElementById("wtr-replacement"),c=t.value.trim(),g=document.getElementById("wtr-is-regex").checked,u=document.getElementById("wtr-whole-word").checked;if((0,i.log)(n.state.globalSettings,`WTR Term Replacer: Saving term - original: "${c}", replacement: "${r.value}", isRegex: ${g}, wholeWord: ${u}, caseSensitive: ${document.getElementById("wtr-case-sensitive").checked}`),!c)return void(0,i.log)(n.state.globalSettings,"WTR Term Replacer: Save term failed - empty original text");if(g&&!d(c))return void(0,i.log)(n.state.globalSettings,"WTR Term Replacer: Save term failed - invalid regex pattern");const p={id:e||`term_${Date.now()}`,original:c,replacement:r.value,caseSensitive:document.getElementById("wtr-case-sensitive").checked,isRegex:g,wholeWord:!g&&u},m=n.state.terms.findIndex(e=>e.id===p.id);m>-1?((0,i.log)(n.state.globalSettings,`WTR Term Replacer: Updating existing term ${p.id}`),n.state.terms[m]=p):((0,i.log)(n.state.globalSettings,`WTR Term Replacer: Adding new term ${p.id}`),n.state.terms.push(p)),await(0,a.saveTerms)(n.state.terms),(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Term saved successfully, total terms: ${n.state.terms.length}`),(0,s.reprocessCurrentChapter)(),t.value="",r.value="",document.getElementById("wtr-term-id").value="",document.getElementById("wtr-case-sensitive").checked=!1,document.getElementById("wtr-is-regex").checked=!1,document.getElementById("wtr-whole-word").checked=!1,document.getElementById("wtr-save-btn").textContent="Save Term",(0,o.renderTermList)(n.state.currentSearchValue),e?((0,i.log)(n.state.globalSettings,"WTR Term Replacer: Switching to terms tab after update"),(0,o.switchTab)("terms")):((0,i.log)(n.state.globalSettings,"WTR Term Replacer: Focusing on original input for next term"),t.focus()),n.state.isDupMode&&((0,i.log)(n.state.globalSettings,"WTR Term Replacer: Updating duplicate mode after term change"),(0,l.updateDupModeAfterChange)())},t.handleSearch=function(e){n.state.isDupMode||(n.state.currentSearchValue=e.target.value,n.state.currentPage=1,(0,o.renderTermList)(n.state.currentSearchValue),(0,a.saveSearchFieldValue)())},t.handleTabSwitch=function(e){const t=e.target.dataset.tab;"terms"===document.querySelector(".wtr-replacer-tab-btn.active").dataset.tab&&(0,a.saveSearchFieldValue)(),document.querySelectorAll(".wtr-replacer-tab-btn").forEach(e=>e.classList.remove("active")),e.target.classList.add("active"),document.querySelectorAll(".wtr-replacer-tab-content").forEach(e=>e.classList.remove("active")),document.getElementById(`wtr-tab-${t}`).classList.add("active"),"terms"===t?p():(0,o.clearTermList)()},t.handleTextSelection=function(e){if(!e.target.closest(".chapter-body"))return;const t=window.getSelection().toString().trim(),r=document.querySelector(".wtr-add-term-float-btn");t&&t.length>0&&t.length<100?r.style.display="block":r.style.display="none"},t.hideUIPanel=function(){(0,i.log)(n.state.globalSettings,"WTR Term Replacer: UI panel hide requested"),(0,o.hideUIPanel)()},t.restoreTermListLocation=p,Object.defineProperty(t,"saveTermListLocation",{enumerable:!0,get:function(){return a.saveTermListLocation}}),t.setSearchFieldValue=u,t.toggleLogging=function(){n.state.globalSettings.isLoggingEnabled=!n.state.globalSettings.isLoggingEnabled,(0,a.saveGlobalSettings)(),alert(`Logging ${n.state.globalSettings.isLoggingEnabled?"enabled":"disabled"}.`)},t.validateRegex=d,t.validateRegexSilent=function(e){try{return new RegExp(e),{isValid:!0,error:null}}catch(e){return{isValid:!1,error:e.message}}};var n=r(730),a=r(310),o=r(433),s=r(361),l=r(949),i=r(58),c=r(921);function d(e){try{return new RegExp(e),(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Valid regex pattern: ${e}`),!0}catch(t){return(0,i.log)(n.state.globalSettings,`WTR Term Replacer: Invalid regex pattern: ${e} - ${t.message}`),!1}}function g(e,t){return new Promise(r=>{const n=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a),r()})}function u(e){const t=document.getElementById("wtr-search-bar");t&&(t.value=e,n.state.currentSearchValue=e,n.state.currentPage=1,(0,o.renderTermList)(n.state.currentSearchValue),(0,a.saveSearchFieldValue)())}async function p(){try{const e=await GM_getValue(`wtr_lab_term_list_location_${n.state.novelSlug}`,null);e&&(n.state.savedTermListLocation=e),n.state.currentPage=n.state.savedTermListLocation.page||1,n.state.currentSearchValue=n.state.savedTermListLocation.searchValue||"";const t=document.getElementById("wtr-search-bar");t&&n.state.currentSearchValue&&(t.value=n.state.currentSearchValue),(0,o.renderTermList)(n.state.currentSearchValue),setTimeout(()=>{const e=document.querySelector(".wtr-replacer-content");e&&n.state.savedTermListLocation.scrollTop&&(e.scrollTop=n.state.savedTermListLocation.scrollTop)},100)}catch(e){console.error("Error restoring term list location:",e)}}},310:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getTermKey=s,t.loadData=async function(){try{const e=`${a.TERMS_STORAGE_KEY_PREFIX}${n.state.novelSlug}`,t=`${a.SETTINGS_STORAGE_KEY_PREFIX}${n.state.novelSlug}`;n.state.terms=await GM_getValue(e,[]),n.state.terms.forEach(e=>{var t;e.wholeWord=null!==(t=e.wholeWord)&&void 0!==t&&t});const r=await GM_getValue(t,{});n.state.settings={isDisabled:!1,...r}}catch(e){console.error("Error loading data:",e),n.state.terms=[],n.state.settings={isDisabled:!1}}},t.loadGlobalSettings=async function(){try{n.state.globalSettings=await GM_getValue(a.GLOBAL_SETTINGS_KEY,{isLoggingEnabled:!1}),(0,o.log)(n.state.globalSettings,"WTR Term Replacer: Global settings loaded")}catch(e){console.error("Error loading global settings:",e),n.state.globalSettings={isLoggingEnabled:!1}}},t.loadTermListLocation=async function(){try{const e=await GM_getValue(`${a.CURRENT_LOCATION_KEY}_${n.state.novelSlug}`,null);e&&(n.state.savedTermListLocation=e)}catch(e){console.error("Error loading term list location:",e),n.state.savedTermListLocation={page:1,scrollTop:0,searchValue:""}}},t.processAndSaveSettings=async function(e){(0,o.log)(n.state.globalSettings,`WTR Term Replacer: Processing settings import for ${Object.keys(e).length} slugs`);for(const t in e){const r=`${a.SETTINGS_STORAGE_KEY_PREFIX}${t}`,s={...await GM_getValue(r,{isDisabled:!1}),...e[t]};await GM_setValue(r,s),t===n.state.novelSlug&&(n.state.settings=s),(0,o.log)(n.state.globalSettings,`WTR Term Replacer: Settings updated for slug ${t}`)}},t.processAndSaveTerms=async function(e,t,r=!0){(0,o.log)(n.state.globalSettings,`WTR Term Replacer: Processing import for slug ${e}, overwrite: ${r}`);const l=`${a.TERMS_STORAGE_KEY_PREFIX}${e}`;let i=await GM_getValue(l,[]);i.forEach(e=>{var t;e.wholeWord=null!==(t=e.wholeWord)&&void 0!==t&&t});let c=[],d=0,g=0,u=0;if(r)(0,o.log)(n.state.globalSettings,`WTR Term Replacer: Overwrite mode - importing ${t.length} terms`),c=t;else{const e=new Map;i.forEach(t=>e.set(s(t),t)),t.forEach(t=>{const r=s(t);if(e.has(r)){const n=e.get(r);n.replacement!==t.replacement||n.wholeWord!==t.wholeWord?u++:g++}else c.push(t),d++}),c=[...i,...c],(0,o.log)(n.state.globalSettings,`WTR Term Replacer: Merge mode - added: ${d}, skipped: ${g}, conflicts: ${u}`)}return await GM_setValue(l,c),e===n.state.novelSlug&&(n.state.terms=c),(0,o.log)(n.state.globalSettings,`WTR Term Replacer: Import complete for ${e} - total terms: ${c.length}`),{added:d,skipped:g,conflicts:u}},t.saveGlobalSettings=async function(){try{await GM_setValue(a.GLOBAL_SETTINGS_KEY,n.state.globalSettings),(0,o.log)(n.state.globalSettings,"WTR Term Replacer: Global settings saved")}catch(e){console.error("Error saving global settings:",e)}},t.saveSearchFieldValue=async function(){try{const e={page:n.state.currentPage,scrollTop:0,searchValue:n.state.currentSearchValue};await GM_setValue(`${a.CURRENT_LOCATION_KEY}_${n.state.novelSlug}`,e),n.state.savedTermListLocation=e}catch(e){console.error("Error saving search field value:",e)}},t.saveSettings=async function(e){try{const t=`${a.SETTINGS_STORAGE_KEY_PREFIX}${n.state.novelSlug}`;await GM_setValue(t,e),n.state.settings=e,(0,o.log)(n.state.globalSettings,"WTR Term Replacer: Settings saved successfully")}catch(e){console.error("Error saving settings:",e),(0,o.log)(n.state.globalSettings,`WTR Term Replacer: Failed to save settings: ${e.message}`),alert("Failed to save settings. Storage might be full.")}},t.saveTermListLocation=async function(){try{const e=document.querySelector(".wtr-replacer-content");if(e){const t={page:n.state.currentPage,scrollTop:e.scrollTop,scrollHeight:e.scrollHeight,clientHeight:e.clientHeight,searchValue:n.state.currentSearchValue,timestamp:Date.now()};await GM_setValue(`${a.CURRENT_LOCATION_KEY}_${n.state.novelSlug}`,t),n.state.savedTermListLocation=t,(0,o.log)(n.state.globalSettings,`WTR Term Replacer: Saved scroll position - top: ${t.scrollTop}, page: ${t.page}`)}}catch(e){console.error("Error saving term list location:",e)}},t.saveTerms=async function(e){try{const t=`${a.TERMS_STORAGE_KEY_PREFIX}${n.state.novelSlug}`;await GM_setValue(t,e),n.state.terms=e,(0,o.log)(n.state.globalSettings,`WTR Term Replacer: Saved ${e.length} terms for novel ${n.state.novelSlug}`)}catch(e){console.error("Error saving terms:",e),(0,o.log)(n.state.globalSettings,`WTR Term Replacer: Failed to save terms: ${e.message}`),alert("Failed to save terms. Storage might be full.")}};var n=r(730),a=function(e){if("function"==typeof WeakMap){var t=new WeakMap;new WeakMap}return function(e){if(e&&e.__esModule)return e;var r,n,a={__proto__:null,default:e};if(null===e||"object"!=typeof e&&"function"!=typeof e)return a;if(r=t){if(r.has(e))return r.get(e);r.set(e,a)}for(const t in e)"default"!==t&&{}.hasOwnProperty.call(e,t)&&((n=(r=Object.defineProperty)&&Object.getOwnPropertyDescriptor(e,t))&&(n.get||n.set)?r(a,t,n):a[t]=e[t]);return a}(e)}(r(621)),o=r(58);function s(e){return`${e.original}|${e.caseSensitive}|${e.isRegex}`}},361:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.processVisibleChapter=l,t.reprocessCurrentChapter=function(){const e=(0,s.getChapterIdFromUrl)(window.location.href);if(!e)return;const t=`#${e} .chapter-body`,r=document.querySelector(t);r&&(r.dataset.wtrProcessed="false",Array.from(n.state.processingQueue).filter(t=>t.startsWith(e)).forEach(e=>n.state.processingQueue.delete(e)),i(e))},t.waitForInitialContent=function(){(0,s.log)(n.state.globalSettings,"WTR Term Replacer: Starting robust content detection for slow-loading websites..."),(0,s.log)(n.state.globalSettings,"WTR Term Replacer: Setting up content change observer"),function(){let e,t=0,r=!1,a=0;new MutationObserver(o=>{const i=Date.now();if(i-t<2e3)return;let c=!1,d=[];for(const e of o)if("childList"===e.type&&e.addedNodes.length>0)for(const t of e.addedNodes)if(t.nodeType===Node.ELEMENT_NODE){var g,u,p,m,b,h,f;const e=(null===(g=t.textContent)||void 0===g?void 0:g.trim())||"";if(null!==(u=t.hasAttribute)&&void 0!==u&&u.call(t,"data-smart-quotes-processed")&&(d.push("Smart Quotes"),c=!0),null!==(p=t.hasAttribute)&&void 0!==p&&p.call(t,"data-uncensor-processed")&&(d.push("Uncensor"),c=!0),(null!==(m=t.hasAttribute)&&void 0!==m&&m.call(t,"data-auto-scroll")||null!==(b=t.hasAttribute)&&void 0!==b&&b.call(t,"data-reader-enhanced"))&&(d.push("Reader Enhancer"),c=!0),e.length>100&&!e.includes("loading")&&!e.includes("...")&&(null!==(h=t.id)&&void 0!==h&&h.includes("chapter")||null!==(f=t.className)&&void 0!==f&&f.includes("chapter")||t.querySelector(".chapter-body"))){c=!0;break}}if(c&&!r){r=!0,t=i,d.length>0?(a++,(0,s.log)(`WTR Term Replacer: Multi-script activity detected from: ${d.join(", ")} (conflict ${a})`),d.forEach(e=>n.state.otherWTRScripts.add(e))):(0,s.log)("WTR Term Replacer: Content changes detected, checking for chapter content...");const o=1500,c=n.state.otherWTRScripts.size>0?2500:o;clearTimeout(e),e=setTimeout(()=>{document.querySelector("[data-wtr-processed]")||n.state.processingQueue.size>0?(0,s.log)(`WTR Term Replacer: Skipping content processing - already in progress or completed (queue: ${n.state.processingQueue.size})`):((0,s.log)(`WTR Term Replacer: Initiating content processing (${n.state.otherWTRScripts.size} other scripts active, ${c}ms coordination delay)`),l()),r=!1},c)}}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class","id"]}),(0,s.log)("WTR Term Replacer: Enhanced content observer activated with multi-script coordination")}(),(0,s.log)(n.state.globalSettings,"WTR Term Replacer: Setting up fallback detection mechanisms"),function(){let e=0;const t=setInterval(()=>{var r;if(document.querySelector("[data-wtr-processed]"))return void clearInterval(t);e++,(0,s.log)(`WTR Term Replacer: Fallback attempt ${e}/10`);const n=(0,s.getChapterIdFromUrl)(window.location.href);if(n){const e=`#${n} .chapter-body`;if(document.querySelector(e))return(0,s.log)("WTR Term Replacer: Fallback processing successful"),l(),void clearInterval(t)}const a=document.querySelector("main, article, .content, .chapter");a&&(null===(r=a.textContent)||void 0===r?void 0:r.trim().length)>200&&((0,s.log)("WTR Term Replacer: Fallback processing with detected content"),l(),clearInterval(t)),e>=10&&(clearInterval(t),(0,s.log)("WTR Term Replacer: Fallback detection exhausted"))},3e3);setTimeout(()=>{clearInterval(t)},3e5)}()};var n=r(730),a=r(921),o=r(433),s=r(58);function l(){const e=(0,s.getChapterIdFromUrl)(window.location.href);if(!e)return;const t=`#${e} .chapter-body`,r=document.querySelector(t);r&&"true"!==r.dataset.wtrProcessed&&i(e)}function i(e,t){const r=`${e}_${Date.now()}`;n.state.processingQueue.has(e)?(0,s.log)(`WTR Term Replacer: Chapter ${e} already queued for processing ${n.state.processingQueue.size} queued`):(n.state.processingQueue.add(r),c(e,[{delay:100,maxContentLoad:.3},{delay:500,maxContentLoad:.5},{delay:1e3,maxContentLoad:.7},{delay:2e3,maxContentLoad:.9},{delay:5e3,maxContentLoad:1}],0,r))}async function c(e,t,r,a){const o=t[r];try{if(await new Promise(e=>setTimeout(e,o.delay)),!n.state.processingQueue.has(a))return void(0,s.log)(`WTR Term Replacer: Chapter ${e} processing cancelled (no longer in queue)`);const l=`#${e} .chapter-body`,i=document.querySelector(l);if(!i)throw new Error("Chapter body element not found");if(!document.contains(i)||i.nodeType!==Node.ELEMENT_NODE)throw new Error("Chapter body element no longer in DOM");const d=function(e){var t,r,n;const a=e.querySelectorAll("p, h1, h2, h3, h4, h5, h6, div, span"),o=Array.from(a).reduce((e,t)=>{var r;return e+((null===(r=t.textContent)||void 0===r?void 0:r.trim().length)||0)},0),s=e.querySelector('.loading, .spinner, [style*="loading"], [class*="loading"]'),l=(null===(t=e.textContent)||void 0===t?void 0:t.includes("Loading..."))||(null===(r=e.textContent)||void 0===r?void 0:r.includes("loading"))||(null===(n=e.textContent)||void 0===n?void 0:n.includes("..."));let i=Math.min(o/1e3,1);return(s||l)&&(i*=.3),Math.max(i,o>100?.5:.1)}(i);d>=o.maxContentLoad?(await g(i,e),n.state.processingQueue.delete(a),(0,s.log)(`WTR Term Replacer: Successfully processed chapter ${e} on attempt ${r+1}`)):r<t.length-1?((0,s.log)(`WTR Term Replacer: Chapter ${e} content not ready (load level: ${d.toFixed(2)}), retrying...`),c(e,t,r+1,a)):((0,s.log)(`WTR Term Replacer: Final attempt for chapter ${e} with available content`),await g(i,e,!0),n.state.processingQueue.delete(a))}catch(o){(0,s.log)(`WTR Term Replacer: Error processing chapter ${e} on attempt ${r+1}:`,o),r<t.length-1?c(e,t,r+1,a):(n.state.processingQueue.delete(a),console.error(`WTR Term Replacer: Failed to process chapter ${e} after all retries`))}}function d(e,t){const r=n.state.processingStartTime.get(e);if(r){const a=Date.now()-r,o=n.state.otherWTRScripts.size>0;return(0,s.log)(n.state.globalSettings,`WTR Term Replacer: Processing timer ended for ${e}, took ${a}ms`),function(e,t,r=!1){const a={chapterId:e,processingTime:`${t}ms`,multiScriptEnvironment:r,activeScripts:n.state.otherWTRScripts.size,queueSize:n.state.processingQueue.size,timestamp:(new Date).toISOString()};r&&n.state.otherWTRScripts.size>0?(a.activeScripts=Array.from(n.state.otherWTRScripts),(0,s.log)(n.state.globalSettings,"WTR Term Replacer: Multi-script enhanced processing completed",a)):(0,s.log)(n.state.globalSettings,"WTR Term Replacer: Standard processing completed",a)}(t,a,o),n.state.processingStartTime.delete(e),a}return(0,s.log)(n.state.globalSettings,`WTR Term Replacer: Warning - processing timer for ${e} not found`),0}async function g(e,t,r=!1){try{if(!r&&!function(e){var t;const r=e.getBoundingClientRect(),n=r.width>0&&r.height>0,a=(null===(t=e.textContent)||void 0===t?void 0:t.trim().length)>50,o=!e.querySelector('.loading, .spinner, [style*="display: none"]');return n&&a&&o}(e))throw new Error("Element not ready for processing");l=`chapter_${t}`,(0,s.log)(n.state.globalSettings,`WTR Term Replacer: Starting processing timer for ${l}`),n.state.processingStartTime.set(l,Date.now()),0===n.state.otherWTRScripts.size&&function(){(0,s.log)(n.state.globalSettings,"WTR Term Replacer: Scanning for other WTR Lab scripts...");const e=document.querySelectorAll("[data-smart-quotes-processed], [data-uncensor-processed], [data-auto-scroll], [data-reader-enhanced]");(0,s.log)(n.state.globalSettings,`WTR Term Replacer: Found ${e.length} elements with WTR script attributes`),e.forEach(e=>{e.hasAttribute("data-smart-quotes-processed")&&(n.state.otherWTRScripts.add("Smart Quotes"),(0,s.log)(n.state.globalSettings,"WTR Term Replacer: Detected Smart Quotes script")),e.hasAttribute("data-uncensor-processed")&&(n.state.otherWTRScripts.add("Uncensor"),(0,s.log)(n.state.globalSettings,"WTR Term Replacer: Detected Uncensor script")),(e.hasAttribute("data-auto-scroll")||e.hasAttribute("data-reader-enhanced"))&&(n.state.otherWTRScripts.add("Reader Enhancer"),(0,s.log)(n.state.globalSettings,"WTR Term Replacer: Detected Reader Enhancer script"))}),n.state.otherWTRScripts.size>0?(0,s.log)(n.state.globalSettings,`WTR Term Replacer: Multi-script environment detected - Active scripts: ${Array.from(n.state.otherWTRScripts).join(", ")}`):(0,s.log)(n.state.globalSettings,"WTR Term Replacer: No other WTR scripts detected, running in single-script mode")}();const i=n.state.otherWTRScripts.size>0;i?(0,s.log)(`WTR Term Replacer: Multi-script processing starting for chapter ${t} with active scripts: ${Array.from(n.state.otherWTRScripts).join(", ")}`):(0,s.log)(`WTR Term Replacer: Processing chapter ${t} with robust method`),(0,a.performReplacements)(e),e.dataset.wtrProcessed="true",(0,o.addMenuButton)();const c=d(`chapter_${t}`,t);i&&(0,s.log)(`WTR Term Replacer: Successfully completed multi-script processing for chapter ${t} in ${c}ms`)}catch(e){const r=d(`chapter_${t}`,t)||0;throw(0,s.log)(`WTR Term Replacer: Robust processing failed for chapter ${t} after ${r}ms:`,e),e}var l}},433:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.addMenuButton=function(){const e=document.querySelector("div.col-6:has(button.term-edit-btn)");if(!e||n.state.observedMenuContainers.has(e))return;const t=()=>{let t=e.querySelector(".replacer-settings-btn");const r=e.querySelector(".term-edit-btn:not(.replacer-settings-btn)");if(!t){if(!r)return;t=function(e){const{text:t="Settings",onClick:r=null,className:n="",tooltip:a=""}=e,o=document.createElement("button");o.className=`replacer-settings-btn ${n}`,a&&(o.title=a);const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("xmlns","http://www.w3.org/2000/svg"),s.setAttribute("height","24px"),s.setAttribute("viewBox","0 -960 960 960"),s.setAttribute("width","24px"),s.setAttribute("fill","#1f1f1f"),s.style.marginRight="4px",s.style.verticalAlign="middle",s.innerHTML='<path d="M700-120h40v-100h100v-40H740v-100h-40v100H600v40h100v100Zm20 80q-83 0-141.5-58.5T520-240q0-83 58.5-141.5T720-440q83 0 141.5 58.5T920-240q0 83-58.5 141.5T720-40ZM280-600h400v-80H280v80Zm187 480H200q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v268q-29-14-58.5-21t-61.5-7q-11 0-20.5.5T680-517v-3H280v80h245q-18 17-32.5 37T467-360H280v80h163q-2 10-2.5 19.5T440-240q0 33 6 61.5t21 58.5Z"/>',o.appendChild(s);const l=document.createElement("span");return l.textContent=t,o.appendChild(l),r&&o.addEventListener("click",r),o}({text:"Term Settings",onClick:d,className:r.className,tooltip:"Open WTR Term Settings"}),e.appendChild(t),(0,o.log)(n.state.globalSettings,"WTR Term Replacer: Settings button created with simple icon system.")}if(e.lastChild!==t&&(e.appendChild(t),(0,o.log)(n.state.globalSettings,"WTR Term Replacer: Settings button order corrected.")),r&&t){const n="1 1 0%";e.style.display="flex",e.style.gap="5px",r.style.flex=n,t.style.flex=n}};t(),new MutationObserver(()=>{(0,o.log)(n.state.globalSettings,"WTR Term Replacer: Detected change in menu container, ensuring button state."),t()}).observe(e,{childList:!0}),n.state.observedMenuContainers.add(e)},t.clearTermList=g,t.createUI=function(){if(document.querySelector(".wtr-replacer-ui"))return;GM_addStyle(i);const e=document.createElement("div");e.className="wtr-replacer-ui",e.innerHTML=l,document.body.appendChild(e);const t=document.createElement("div");t.className="wtr-processing-overlay",t.textContent="Processing...",document.body.appendChild(t),e.querySelector(".wtr-replacer-close-btn").addEventListener("click",a.hideUIPanel),e.querySelector("#wtr-disable-all").addEventListener("change",a.handleDisableToggle),e.querySelector("#wtr-save-btn").addEventListener("click",a.handleSaveTerm),e.querySelector("#wtr-delete-selected-btn").addEventListener("click",a.handleDeleteSelected),e.querySelector("#wtr-search-bar").addEventListener("input",a.handleSearch),e.querySelector(".wtr-replacer-term-list").addEventListener("click",a.handleListInteraction),e.querySelectorAll(".wtr-replacer-tab-btn").forEach(e=>e.addEventListener("click",a.handleTabSwitch)),e.querySelector("#wtr-export-novel-btn").addEventListener("click",a.handleExportNovel),e.querySelector("#wtr-export-all-btn").addEventListener("click",a.handleExportAll),e.querySelector("#wtr-export-combined-btn").addEventListener("click",a.handleExportCombined),e.querySelector("#wtr-import-novel-btn").addEventListener("click",()=>{n.state.importType="novel",document.getElementById("wtr-file-input").click()}),e.querySelector("#wtr-import-all-btn").addEventListener("click",()=>{n.state.importType="all",document.getElementById("wtr-file-input").click()}),e.querySelector("#wtr-file-input").addEventListener("change",a.handleFileImport),e.querySelector("#wtr-find-duplicates-btn").addEventListener("click",a.handleFindDuplicates),e.querySelector("#wtr-prev-dup-btn").addEventListener("click",()=>a.changeDupGroup(-1)),e.querySelector("#wtr-next-dup-btn").addEventListener("click",()=>a.changeDupGroup(1)),e.querySelector("#wtr-exit-dup-btn").addEventListener("click",a.exitDupMode);const r=e.querySelector(".wtr-replacer-content");if(r){let e;r.addEventListener("scroll",()=>{clearTimeout(e),e=setTimeout(()=>{"terms"===document.querySelector(".wtr-replacer-tab-btn.active").dataset.tab&&a.saveTermListLocation()},1e3)})}const d=e.querySelector("#wtr-is-regex"),g=e.querySelector("#wtr-whole-word");d.addEventListener("change",e=>{g.disabled=e.target.checked,e.target.checked&&(g.checked=!1)});const u=e.querySelector("#wtr-original");function p(){if(!u)return;const e=u.value.length,t=Math.ceil(e/40),r=Math.min(t,1/0);u.rows=Math.max(1,r)}u.addEventListener("input",p),u.addEventListener("focus",p);const m=e.querySelector("#wtr-save-btn"),b=e.querySelector("#wtr-replacement");function h(e){u.classList.remove("wtr-field-invalid","wtr-field-valid"),"invalid"===e?u.classList.add("wtr-field-invalid"):"valid"===e&&u.classList.add("wtr-field-valid")}function f(){const e=d.checked,t=u.value.trim(),r=b.value.trim(),n=t.length>0&&r.length>0;if(!e||0===t.length)return h(null),void(m.disabled=!n);a.validateRegexSilent(t).isValid?(h("valid"),m.disabled=!n):(h("invalid"),m.disabled=!0)}u.addEventListener("input",f),b.addEventListener("input",f),d.addEventListener("change",f),f();const w=document.createElement("button");w.className="wtr-add-term-float-btn",w.textContent="Add Term",document.body.appendChild(w),w.addEventListener("click",a.handleAddTermFromSelection),document.addEventListener("mouseup",a.handleTextSelection),document.addEventListener("touchend",a.handleTextSelection),e.querySelector("#wtr-first-page-btn").addEventListener("click",()=>{n.state.currentPage>1&&(n.state.currentPage=1,c(n.state.currentSearchValue))}),e.querySelector("#wtr-prev-page-btn").addEventListener("click",()=>{n.state.currentPage>1&&(n.state.currentPage--,c(n.state.currentSearchValue))}),e.querySelector("#wtr-next-page-btn").addEventListener("click",()=>{const e=n.state.terms.filter(e=>e.original.toLowerCase().includes(n.state.currentSearchValue.toLowerCase())||e.replacement.toLowerCase().includes(n.state.currentSearchValue.toLowerCase())),t=Math.ceil(e.length/s.ITEMS_PER_PAGE)||1;n.state.currentPage<t&&(n.state.currentPage++,c(n.state.currentSearchValue))}),e.querySelector("#wtr-last-page-btn").addEventListener("click",()=>{const e=n.state.terms.filter(e=>e.original.toLowerCase().includes(n.state.currentSearchValue.toLowerCase())||e.replacement.toLowerCase().includes(n.state.currentSearchValue.toLowerCase())),t=Math.ceil(e.length/s.ITEMS_PER_PAGE)||1;n.state.currentPage<t&&(n.state.currentPage=t,c(n.state.currentSearchValue))}),(0,o.log)(n.state.globalSettings,"WTR Term Replacer: UI created successfully")},t.hideUILoader=function(){const e=document.getElementById("wtr-ui-loader");e&&(e.style.display="none");const t=document.querySelector(".wtr-replacer-content");t&&(t.style.pointerEvents="auto")},t.hideUIPanel=function(){a.saveTermListLocation(),document.querySelector(".wtr-replacer-ui").style.display="none",g()},t.renderTermList=c,t.showFormView=function(e=null){document.getElementById("wtr-term-id").value=e?e.id:"",document.getElementById("wtr-original").value=e?e.original:"",document.getElementById("wtr-replacement").value=e?e.replacement:"",document.getElementById("wtr-case-sensitive").checked=!!e&&e.caseSensitive,document.getElementById("wtr-is-regex").checked=!!e&&e.isRegex,document.getElementById("wtr-whole-word").checked=!!e&&e.wholeWord,document.getElementById("wtr-whole-word").disabled=!!e&&e.isRegex,document.getElementById("wtr-save-btn").textContent=e?"Update Term":"Save Term",u("add"),setTimeout(()=>{const e=document.getElementById("wtr-original");if(e){const t=e.value.length,r=Math.ceil(t/40);e.rows=Math.max(1,r)}if(document.getElementById("wtr-is-regex")){const t=new Event("input",{bubbles:!0});e.dispatchEvent(t)}},10)},t.showProcessingIndicator=function(e){const t=document.querySelector(".wtr-processing-overlay");t&&(t.style.display=e?"flex":"none")},t.showUILoader=function(){const e=document.getElementById("wtr-ui-loader");e&&(e.style.display="flex");const t=document.querySelector(".wtr-replacer-content");t&&(t.style.pointerEvents="none")},t.showUIPanel=d,t.switchTab=u;var n=r(730),a=function(e){if("function"==typeof WeakMap){var t=new WeakMap;new WeakMap}return function(e){if(e&&e.__esModule)return e;var r,n,a={__proto__:null,default:e};if(null===e||"object"!=typeof e&&"function"!=typeof e)return a;if(r=t){if(r.has(e))return r.get(e);r.set(e,a)}for(const t in e)"default"!==t&&{}.hasOwnProperty.call(e,t)&&((n=(r=Object.defineProperty)&&Object.getOwnPropertyDescriptor(e,t))&&(n.get||n.set)?r(a,t,n):a[t]=e[t]);return a}(e)}(r(170)),o=r(58),s=r(621);const l='\n    <div class="wtr-replacer-header">\n        <h2>Term Replacer v5.4</h2>\n        <div class="wtr-replacer-header-controls">\n            <div class="wtr-replacer-disable-toggle">\n                <label><input type="checkbox" id="wtr-disable-all"> Disable All</label>\n            </div>\n            <button class="wtr-replacer-close-btn">&times;</button>\n        </div>\n    </div>\n    <div class="wtr-replacer-tabs">\n        <button class="wtr-replacer-tab-btn active" data-tab="terms">Terms List</button>\n        <button class="wtr-replacer-tab-btn" data-tab="add">Add/Edit Term</button>\n        <button class="wtr-replacer-tab-btn" data-tab="io">Import/Export</button>\n    </div>\n    <div class="wtr-replacer-content">\n        <div class="wtr-ui-loader" id="wtr-ui-loader">Loading...</div>\n        <div id="wtr-tab-terms" class="wtr-replacer-tab-content active">\n            <div id="wtr-dup-message" class="wtr-dup-message" style="display:none;"></div>\n            <div id="wtr-dup-controls" class="wtr-dup-controls" style="display:none;">\n                <button id="wtr-prev-dup-btn" class="btn btn-secondary">Previous</button>\n                <button id="wtr-next-dup-btn" class="btn btn-secondary">Next</button>\n                <button id="wtr-exit-dup-btn" class="btn btn-secondary">Exit Duplicate Mode</button>\n            </div>\n            <div class="wtr-replacer-list-controls">\n                <input type="text" id="wtr-search-bar" class="wtr-replacer-search-bar" placeholder="Search terms...">\n                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">\n                    <button id="wtr-find-duplicates-btn" class="btn btn-secondary">Find Duplicates</button>\n                    <button id="wtr-delete-selected-btn" class="btn btn-secondary">Delete Selected</button>\n                </div>\n            </div>\n            <ul class="wtr-replacer-term-list"></ul>\n            <div class="wtr-pagination-controls">\n                <button id="wtr-first-page-btn" class="btn btn-secondary" title="First Page">&laquo;&laquo;</button>\n                <button id="wtr-prev-page-btn" class="btn btn-secondary" title="Previous Page">&laquo;</button>\n                <span id="wtr-page-indicator"></span>\n                <button id="wtr-next-page-btn" class="btn btn-secondary" title="Next Page">&raquo;</button>\n                <button id="wtr-last-page-btn" class="btn btn-secondary" title="Last Page">&raquo;&raquo;</button>\n            </div>\n        </div>\n        <div id="wtr-tab-add" class="wtr-replacer-tab-content">\n            <input type="hidden" id="wtr-term-id">\n            <div class="wtr-replacer-form-group">\n                <label for="wtr-original">Original Text</label>\n                <textarea id="wtr-original" rows="1"></textarea>\n            </div>\n            <div class="wtr-replacer-form-group">\n                <label for="wtr-replacement">Replacement Text</label>\n                <input type="text" id="wtr-replacement">\n            </div>\n            <div class="wtr-replacer-form-group">\n                <label><input type="checkbox" id="wtr-case-sensitive"> Case Sensitive</label>\n                <label><input type="checkbox" id="wtr-is-regex"> Use Regex</label>\n                <label><input type="checkbox" id="wtr-whole-word" disabled> Whole Word Only</label>\n            </div>\n            <button id="wtr-save-btn" class="btn btn-primary">Save Term</button>\n        </div>\n        <div id="wtr-tab-io" class="wtr-replacer-tab-content">\n            <input type="file" id="wtr-file-input" accept=".json" style="display: none;">\n            <div class="wtr-replacer-io-section">\n                <h3>Export</h3>\n                <div class="wtr-replacer-io-actions" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">\n                    <button id="wtr-export-novel-btn" class="btn btn-success">Export Novel Terms</button>\n                    <button id="wtr-export-all-btn" class="btn btn-success">Export All Terms</button>\n                    <button id="wtr-export-combined-btn" class="btn btn-info wtr-export-combined">Export Both (Novel + All)</button>\n                </div>\n            </div>\n            <div class="wtr-replacer-io-section">\n                <h3>Import</h3>\n                <div class="wtr-replacer-io-actions" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">\n                    <button id="wtr-import-novel-btn" class="btn btn-warning">Import to This Novel</button>\n                    <button id="wtr-import-all-btn" class="btn btn-warning">Import All (Global)</button>\n                </div>\n            </div>\n        </div>\n    </div>\n',i="\n    /* --- Google Material Symbols --- */\n    @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0');\n    \n    .material-symbols-outlined {\n        font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;\n        font-size: 16px;\n        vertical-align: middle;\n    }\n\n    /* --- Main UI Container --- */\n    .wtr-replacer-ui {\n        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);\n        width: 90%; max-width: 650px; max-height: 80vh;\n        background-color: var(--bs-body-bg); color: var(--bs-body-color);\n        border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius-lg);\n        box-shadow: var(--bs-box-shadow-lg); z-index: 99999;\n        display: none; flex-direction: column; font-family: var(--bs-body-font-family);\n    }\n    .wtr-replacer-ui * { box-sizing: border-box; }\n\n    /* --- Header --- */\n    .wtr-replacer-header {\n        padding: 0.75rem 1rem; background-color: var(--bs-tertiary-bg);\n        border-bottom: 1px solid var(--bs-border-color);\n        display: flex; justify-content: space-between; align-items: center;\n        border-radius: var(--bs-border-radius-lg) var(--bs-border-radius-lg) 0 0;\n    }\n    .wtr-replacer-header h2 { margin: 0; font-size: 1.25rem; }\n    .wtr-replacer-header-controls { display: flex; align-items: center; gap: 1rem; }\n    .wtr-replacer-disable-toggle label { display: flex; align-items: center; cursor: pointer; font-size: 0.9rem; }\n    .wtr-replacer-disable-toggle input { margin-right: 0.5rem; }\n    .wtr-replacer-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; line-height: 1; color: inherit; padding: 0; }\n\n    /* --- Tabs --- */\n    .wtr-replacer-tabs { display: flex; padding: 0 0.5rem; border-bottom: 1px solid var(--bs-border-color); background-color: var(--bs-tertiary-bg); }\n    .wtr-replacer-tab-btn {\n        background: none; border: none; padding: 0.75rem 1rem; cursor: pointer;\n        font-size: 0.9rem; color: var(--bs-secondary-color);\n        border-bottom: 3px solid transparent; margin-bottom: -1px;\n    }\n    .wtr-replacer-tab-btn.active { color: var(--bs-primary); border-bottom-color: var(--bs-primary); font-weight: bold; }\n\n    /* --- Content & Forms --- */\n    .wtr-replacer-content { padding: 1rem; overflow-y: auto; flex-grow: 1; position: relative; }\n    .wtr-replacer-tab-content { display: none; }\n    .wtr-replacer-tab-content.active { display: block; }\n    .wtr-replacer-form-group { margin-bottom: 1rem; }\n    .wtr-replacer-form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; font-size: 0.9rem; }\n    .wtr-replacer-form-group input[type=\"text\"], .wtr-replacer-search-bar {\n        width: 100%; padding: 0.5rem 0.75rem;\n        background-color: var(--bs-body-bg); color: var(--bs-body-color);\n        border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius);\n    }\n    .wtr-replacer-form-group textarea {\n        width: 100%; padding: 0.5rem 0.75rem;\n        background-color: var(--bs-body-bg); color: var(--bs-body-color);\n        border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius);\n        resize: none;\n        min-height: 2.5rem; max-height: 10rem;\n        line-height: 1.5; font-family: inherit;\n        word-wrap: break-word; white-space: pre-wrap;\n    }\n    .wtr-replacer-form-group input[type=\"checkbox\"] { margin-right: 0.5rem; }\n\n    /* --- Visual Validation States --- */\n    .wtr-replacer-form-group .wtr-field-invalid {\n        border-color: var(--bs-danger) !important;\n        background-color: rgba(var(--bs-danger-rgb), 0.1) !important;\n        box-shadow: 0 0 0 0.2rem rgba(var(--bs-danger-rgb), 0.25);\n    }\n    \n    .wtr-replacer-form-group .wtr-field-valid {\n        border-color: var(--bs-success) !important;\n        background-color: rgba(var(--bs-success-rgb), 0.1) !important;\n    }\n    \n    .wtr-save-btn:disabled {\n        opacity: 0.6;\n        cursor: not-allowed;\n        background-color: var(--bs-secondary);\n        border-color: var(--bs-secondary);\n    }\n\n    /* --- Buttons (Scoped to UI) --- */\n    .wtr-replacer-ui .btn {\n        display: inline-block; font-weight: 400; line-height: 1.5; color: var(--bs-body-color);\n        text-align: center; vertical-align: middle; cursor: pointer; user-select: none;\n        background-color: transparent; border: 1px solid transparent;\n        padding: 0.375rem 0.75rem; font-size: 1rem; border-radius: var(--bs-border-radius);\n        transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;\n    }\n    .wtr-replacer-ui .btn:disabled { opacity: 0.65; cursor: not-allowed; }\n    .wtr-replacer-ui .btn-primary { color: #fff; background-color: var(--bs-primary); border-color: var(--bs-primary); }\n    .wtr-replacer-ui .btn-secondary { color: #fff; background-color: var(--bs-secondary); border-color: var(--bs-secondary); }\n    .wtr-replacer-ui .btn-success { color: #fff; background-color: var(--bs-success); border-color: var(--bs-success); }\n    .wtr-replacer-ui .btn-warning { color: #000; background-color: var(--bs-warning); border-color: var(--bs-warning); }\n    .wtr-replacer-ui .btn-info { color: #fff; background-color: var(--bs-info); border-color: var(--bs-info); }\n\n    /* --- Term List --- */\n    .wtr-replacer-list-controls {\n        display: flex; justify-content: space-between; align-items: center;\n        gap: 0.75rem; position: sticky; top: -1rem;\n        background-color: var(--bs-body-bg); padding: 0.75rem 0; z-index: 10;\n        flex-wrap: wrap;\n    }\n    .wtr-replacer-term-list { list-style: none; padding: 0; margin: 0; }\n    .wtr-replacer-term-item {\n        padding: 0.75rem; border: 1px solid var(--bs-border-color);\n        border-radius: var(--bs-border-radius); margin-bottom: 0.5rem;\n        display: flex; align-items: center; gap: 0.75rem;\n        background-color: var(--bs-secondary-bg-subtle);\n    }\n    .wtr-replacer-term-details { flex-grow: 1; overflow: hidden; }\n    .wtr-replacer-term-text { font-family: var(--bs-font-monospace); font-size: 0.9rem; word-wrap: break-word; }\n    .wtr-term-original { color: var(--bs-danger) !important; font-weight: bold; }\n    .wtr-term-replacement { color: var(--bs-success) !important; font-weight: bold; }\n\n    /* --- Floating Button --- */\n    .wtr-add-term-float-btn {\n        position: fixed; bottom: 20px; right: 20px;\n        background-color: var(--bs-primary); color: white;\n        padding: 0.75rem 1.25rem; border-radius: 50rem; border: none;\n        box-shadow: var(--bs-box-shadow); cursor: pointer; font-size: 1rem; z-index: 99998; display: none;\n    }\n\n    /* --- Overlays & Loaders --- */\n    .wtr-processing-overlay {\n        position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n        background: rgba(0,0,0,0.5); color: white;\n        display: flex; justify-content: center; align-items: center;\n        font-size: 1.5rem; z-index: 100000; display: none;\n    }\n    .wtr-ui-loader {\n        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;\n        background: rgba(var(--bs-body-bg-rgb), 0.7); color: var(--bs-body-color);\n        justify-content: center; align-items: center; z-index: 20;\n    }\n\n    /* --- Duplicate Mode & Pagination --- */\n    .wtr-dup-message { margin-bottom: 0.75rem; font-weight: bold; }\n    .wtr-dup-controls { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }\n    .wtr-pagination-controls {\n        display: flex; justify-content: center; align-items: center; margin-top: 1rem; gap: 0.25rem;\n        flex-wrap: wrap; padding: 0.5rem 0;\n    }\n    .wtr-pagination-controls .btn {\n        padding: 0.25rem 0.5rem; font-size: 0.875rem; min-width: 2.5rem;\n    }\n    #wtr-page-indicator {\n        white-space: nowrap; margin: 0 0.5rem; font-size: 0.875rem;\n        padding: 0.25rem 0.5rem; background-color: var(--bs-secondary-bg-subtle);\n        border-radius: var(--bs-border-radius);\n    }\n\n    /* --- Enhanced Export Button Styling --- */\n    .wtr-export-combined {\n        background: linear-gradient(45deg, var(--bs-success), #28a745);\n        border: none;\n        color: white;\n        font-weight: bold;\n        position: relative;\n        overflow: hidden;\n    }\n\n    .wtr-export-combined:hover {\n        background: linear-gradient(45deg, #28a745, var(--bs-success));\n        transform: translateY(-1px);\n        box-shadow: 0 4px 8px rgba(0,0,0,0.2);\n    }\n\n    .wtr-export-combined:active {\n        transform: translateY(0);\n    }\n\n    /* --- Responsive Design (Mobile First) --- */\n    #wtr-tab-terms.active {\n        display: flex;\n        flex-direction: column;\n    }\n    .wtr-replacer-list-controls { order: 1; }\n    .wtr-pagination-controls { order: 2; margin-top: 0.5rem; margin-bottom: 0.5rem; }\n    .wtr-replacer-term-list { order: 3; }\n\n    /* --- Mobile Specific Improvements --- */\n    @media (max-width: 768px) {\n        .wtr-replacer-ui {\n            width: 95%; max-height: 85vh;\n            top: 2.5%; left: 2.5%; transform: none;\n        }\n\n        .wtr-replacer-content {\n            padding: 0.5rem;\n        }\n\n        .wtr-replacer-list-controls {\n            flex-direction: column; align-items: stretch; gap: 0.5rem;\n        }\n\n        .wtr-replacer-list-controls input[type=\"text\"] {\n            order: 1;\n        }\n\n        .wtr-replacer-list-controls .btn {\n            order: 2; margin: 0;\n        }\n\n        .wtr-dup-controls {\n            justify-content: center;\n        }\n\n        .wtr-pagination-controls {\n            justify-content: center;\n            gap: 0.125rem;\n        }\n\n        .wtr-pagination-controls .btn {\n            padding: 0.375rem 0.5rem;\n            font-size: 0.8rem;\n            min-width: 2rem;\n        }\n\n        #wtr-page-indicator {\n            font-size: 0.8rem;\n            margin: 0 0.25rem;\n            padding: 0.25rem;\n        }\n\n        .wtr-replacer-term-item {\n            padding: 0.5rem;\n            gap: 0.5rem;\n        }\n\n        .wtr-replacer-term-text {\n            font-size: 0.8rem;\n        }\n    }\n\n    @media (min-width: 769px) {\n        .wtr-replacer-list-controls { order: 1; }\n        .wtr-replacer-term-list { order: 2; }\n        .wtr-pagination-controls { order: 3; margin-top: 1rem; margin-bottom: 0; }\n    }\n";function c(e=""){const t=document.querySelector(".wtr-replacer-term-list"),r=document.querySelector(".wtr-pagination-controls"),a=document.getElementById("wtr-page-indicator"),o=document.getElementById("wtr-first-page-btn"),l=document.getElementById("wtr-prev-page-btn"),i=document.getElementById("wtr-next-page-btn"),c=document.getElementById("wtr-last-page-btn"),d=document.querySelector(".wtr-replacer-content");if(!(t&&r&&a&&l&&i&&o&&c))return;const g=d?d.scrollTop:0,u=g>0&&!n.state.isDupMode&&e===n.state.currentSearchValue;let p,m;if(t.innerHTML="",n.state.isDupMode){const e=n.state.dupKeys[n.state.currentDupIndex];p=n.state.dupGroups.get(e)||[],document.getElementById("wtr-dup-message").textContent=`Duplicate group ${n.state.currentDupIndex+1} of ${n.state.dupKeys.length}  ${e}`,document.getElementById("wtr-dup-message").style.display="block",document.getElementById("wtr-dup-controls").style.display="flex",document.getElementById("wtr-prev-dup-btn").disabled=0===n.state.currentDupIndex,document.getElementById("wtr-next-dup-btn").disabled=n.state.currentDupIndex===n.state.dupKeys.length-1,document.getElementById("wtr-search-bar").disabled=!0,r.style.display="none",m=p}else{const t=e.toLowerCase();p=n.state.terms.filter(e=>e.original.toLowerCase().includes(t)||e.replacement.toLowerCase().includes(t)),document.getElementById("wtr-dup-message").style.display="none",document.getElementById("wtr-dup-controls").style.display="none",document.getElementById("wtr-search-bar").disabled=!1;const d=Math.ceil(p.length/s.ITEMS_PER_PAGE)||1;n.state.currentPage=Math.max(1,Math.min(n.state.currentPage,d));const g=(n.state.currentPage-1)*s.ITEMS_PER_PAGE,u=g+s.ITEMS_PER_PAGE;m=p.slice(g,u),d>1?(r.style.display="flex",a.textContent=`Page ${n.state.currentPage} of ${d}`,o.disabled=1===n.state.currentPage,l.disabled=1===n.state.currentPage,i.disabled=n.state.currentPage===d,c.disabled=n.state.currentPage===d):r.style.display="none"}if(0===m.length)t.innerHTML=0===n.state.terms.length?"<li>No terms defined.</li>":"<li>No terms match search.</li>";else{const e=document.createDocumentFragment();m.forEach(t=>{const r=document.createElement("li");r.className="wtr-replacer-term-item",r.dataset.id=t.id,r.innerHTML=`\n        <input type="checkbox" class="wtr-replacer-term-select" data-id="${t.id}">\n        <div class="wtr-replacer-term-details">\n          <div class="wtr-replacer-term-text">\n            <span class="wtr-term-original">${t.original}</span>  <span class="wtr-term-replacement">${t.replacement}</span>\n          </div>\n          <div>${t.caseSensitive?"<small>CS</small>":""} ${t.isRegex?"<small>RX</small>":""} ${t.wholeWord?"<small>WW</small>":""}</div>\n        </div>\n        <div><button class="btn btn-secondary btn-sm wtr-edit-btn" data-id="${t.id}">Edit</button></div>\n      `,e.appendChild(r)}),t.appendChild(e)}u&&d&&requestAnimationFrame(()=>{d.scrollTop=g})}function d(){document.querySelector(".wtr-replacer-ui").style.display="flex",document.getElementById("wtr-disable-all").checked=n.state.settings.isDisabled,"terms"===document.querySelector(".wtr-replacer-tab-btn.active").dataset.tab?a.restoreTermListLocation():c()}function g(){const e=document.querySelector(".wtr-replacer-term-list");e&&(e.innerHTML="")}function u(e){document.querySelector(`.wtr-replacer-tab-btn[data-tab="${e}"]`).click()}},621:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TERMS_STORAGE_KEY_PREFIX=t.SETTINGS_STORAGE_KEY_PREFIX=t.ITEMS_PER_PAGE=t.GLOBAL_SETTINGS_KEY=t.CURRENT_LOCATION_KEY=t.CHAPTER_BODY_SELECTOR=void 0,t.CHAPTER_BODY_SELECTOR=".chapter-body",t.TERMS_STORAGE_KEY_PREFIX="wtr_lab_terms_",t.SETTINGS_STORAGE_KEY_PREFIX="wtr_lab_settings_",t.GLOBAL_SETTINGS_KEY="wtr_lab_global_settings",t.CURRENT_LOCATION_KEY="wtr_lab_term_list_location",t.ITEMS_PER_PAGE=100},730:(e,t,r)=>{function n(e,t){if("function"==typeof WeakMap)var r=new WeakMap,a=new WeakMap;return(n=function(e,t){if(!t&&e&&e.__esModule)return e;var n,o,s={__proto__:null,default:e};if(null===e||"object"!=typeof e&&"function"!=typeof e)return s;if(n=t?a:r){if(n.has(e))return n.get(e);n.set(e,s)}for(const t in e)"default"!==t&&{}.hasOwnProperty.call(e,t)&&((o=(n=Object.defineProperty)&&Object.getOwnPropertyDescriptor(e,t))&&(o.get||o.set)?n(s,t,o):s[t]=e[t]);return s})(e,t)}Object.defineProperty(t,"__esModule",{value:!0}),t.initializeState=function(){return a.novelSlug||Promise.resolve().then(()=>n(r(58))).then(({getNovelSlug:e})=>{a.novelSlug=e()}),a.novelSlug},t.setNovelSlug=function(e){a.novelSlug=e},t.state=void 0;const a=t.state={novelSlug:null,terms:[],settings:{isDisabled:!1},globalSettings:{isLoggingEnabled:!1},importType:"novel",currentSearchValue:"",isDupMode:!1,dupGroups:new Map,dupKeys:[],currentDupIndex:0,currentPage:1,savedTermListLocation:{page:1,scrollTop:0,searchValue:""},originalTextNodes:new WeakMap,otherWTRScripts:new Set,processingStartTime:new Map,domConflictDetected:!1,multiScriptPerformanceImpact:new Map,currentURL:window.location.href,processingQueue:new Set,isProcessingInProgress:!1,observedMenuContainers:new WeakSet}},921:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.executeReplacementLogic=i,t.performReplacements=async function(e){if(e){if((0,a.log)(n.state.globalSettings,"WTR Term Replacer: Starting performReplacements"),(0,o.showProcessingIndicator)(!0),await new Promise(e=>setTimeout(e,10)),n.state.settings.isDisabled||0===n.state.terms.length)return(0,a.log)(n.state.globalSettings,`WTR Term Replacer: Skipping replacements - disabled: ${n.state.settings.isDisabled}, terms: ${n.state.terms.length}`),void(0,o.showProcessingIndicator)(!1);try{(0,a.log)(n.state.globalSettings,`WTR Term Replacer: Found ${n.state.terms.length} terms to process, beginning replacement with retry mechanism`),await async function(e){var t;let r=null,o=0;(0,a.log)(n.state.globalSettings,"WTR Term Replacer: Starting replacement process with 3 retries");for(let t=1;t<=3;t++)try{if((0,a.log)(n.state.globalSettings,`WTR Term Replacer: Replacement attempt ${t}/3`),!l(e,o)){(0,a.log)(n.state.globalSettings,`WTR Term Replacer: Element stability check failed, attempt ${o}`);const t=(0,a.getChapterIdFromUrl)(window.location.href);if(!t)throw(0,a.log)(n.state.globalSettings,"WTR Term Replacer: Cannot determine chapter ID for element recovery"),new Error("Cannot determine chapter ID for element recovery");{const r=`#${t} ${s.CHAPTER_BODY_SELECTOR}`;if(!(e=document.querySelector(r)))throw(0,a.log)(n.state.globalSettings,`WTR Term Replacer: Unable to re-acquire target element for chapter ${t}`),new Error("Unable to re-acquire target element");(0,a.log)(n.state.globalSettings,`WTR Term Replacer: Re-acquired target element for chapter ${t}`),o++}}if(!document.contains(e)||!e.parentNode)throw(0,a.log)(n.state.globalSettings,"WTR Term Replacer: Target element validation failed - not in stable DOM"),new Error("Target element not in stable DOM");return(0,a.log)(n.state.globalSettings,"WTR Term Replacer: Element validation passed, executing replacement logic"),await i(e),void(0,a.log)(n.state.globalSettings,`WTR Term Replacer: Replacement attempt ${t} successful`)}catch(e){if(r=e,(0,a.log)(n.state.globalSettings,`WTR Term Replacer: Replacement attempt ${t} failed:`,e.message),t<3){const r=Math.min(100*Math.pow(2,t-1),2e3);(0,a.log)(n.state.globalSettings,`WTR Term Replacer: Retrying in ${r}ms...`),await new Promise(e=>setTimeout(e,r)),e.message&&e.message.includes("DOM")&&o++}else(0,a.log)(n.state.globalSettings,"WTR Term Replacer: All 3 attempts failed, giving up")}throw(0,a.log)(n.state.globalSettings,`WTR Term Replacer: All replacement attempts failed, throwing error: ${(null===(t=r)||void 0===t?void 0:t.message)||"Unknown error"}`),r||new Error("Unknown replacement error")}(e)}catch(e){(0,a.log)(n.state.globalSettings,"WTR Term Replacer: Failed to perform replacements after retries:",e),console.error("WTR Term Replacer: Replacement failed, but original content preserved")}finally{(0,o.showProcessingIndicator)(!1),(0,a.log)(n.state.globalSettings,"WTR Term Replacer: performReplacements completed")}}else(0,a.log)(n.state.globalSettings,"WTR Term Replacer: performReplacements called with null target element")},t.revertAllReplacements=async function(e){e&&((0,o.showProcessingIndicator)(!0),await new Promise(e=>setTimeout(e,10)),c(e),(0,o.showProcessingIndicator)(!1))},t.traverseAndRevert=c;var n=r(730),a=r(58),o=r(433),s=r(621);function l(e,t){if(!e||!document.contains(e))return!1;const r=e.getBoundingClientRect();if(0===r.width||0===r.height)return!1;let n=e.parentNode,a=0;for(;n&&a<10;){if(!document.contains(n))return!1;n=n.parentNode,a++}return t<3}async function i(e){var t;if(!e||e.nodeType!==Node.ELEMENT_NODE)throw new Error("Invalid target element");if(!l(e,0))throw new Error("Target element DOM stability check failed");if(0===((null===(t=e.textContent)||void 0===t?void 0:t.trim())||"").length){var r;const t=(0,a.getChapterIdFromUrl)(window.location.href)||"unknown",o=(null===(r=e.textContent)||void 0===r?void 0:r.length)||0;return void(0,a.log)(n.state.globalSettings,`WTR Term Replacer: Target element has no text content in chapter ${t} (${o} chars), skipping`)}const s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),i=[];let c;for(;c=s.nextNode();)c.parentElement.closest(".wtr-replacer-ui, script, style")||i.push(c);const d=new Map,g=[];let u="",p=0;if(i.forEach(e=>{n.state.originalTextNodes.has(e)||n.state.originalTextNodes.set(e,e.nodeValue);const t=n.state.originalTextNodes.get(e);d.set(e,t),t.length>0&&g.push({node:e,start:p,end:p+t.length}),u+=t,p+=t.length}),!u.trim())return void(0,o.showProcessingIndicator)(!1);const m=new Map,b=new Map,h=new Map,f=new Map,w=[];for(const e of n.state.terms)if(e.original)if(e.isRegex)try{const t=e.caseSensitive?"g":"gi";w.push({pattern:new RegExp(e.original,t),replacement:e.replacement})}catch(t){console.error(`Skipping invalid regex for term "${e.original}":`,t)}else{const t=e.caseSensitive?e.original:e.original.toLowerCase(),r=e.replacement;e.caseSensitive?e.wholeWord?b.set(t,r):m.set(t,r):e.wholeWord?f.set(t,r):h.set(t,r)}const v=[...w],T=(e,t,r,n)=>{if(e.size>0){const o=[...e.keys()].sort((e,t)=>t.length-e.length).map(e=>{const t=(0,a.escapeRegExp)(e);return r?`\\b${t}\\b`:t}).join("|");v.push({pattern:new RegExp(o,t),replacement_map:e,is_simple:!0,case_sensitive:n})}};T(m,"g",!1,!0),T(b,"g",!0,!0),T(h,"gi",!1,!1),T(f,"gi",!0,!1);let y=[];for(const e of v)for(const t of u.matchAll(e.pattern)){if(t.index===t.index+t[0].length)continue;let r;if(e.is_simple){const n=e.case_sensitive?t[0]:t[0].toLowerCase();r=e.replacement_map.get(n)}else r=e.replacement;void 0!==r&&y.push({start:t.index,end:t.index+t[0].length,replacement:r})}y.sort((e,t)=>e.start!==t.start?e.start-t.start:t.end-e.end);const S=[];let R=-1;for(const e of y)e.start>=R&&(S.push(e),R=e.end);for(const e of S.reverse()){const{start:t,end:r,replacement:n}=e,a=[];for(const e of g)e.start<r&&e.end>t&&a.push(e);if(0===a.length)continue;const o=a[0],s=a[a.length-1],l=o.node,i=s.node,c=t-o.start,u=r-s.start;if(l===i){let e=d.get(l);d.set(l,e.substring(0,c)+n+e.substring(u))}else{let e=d.get(i);d.set(i,e.substring(u));for(let e=1;e<a.length-1;e++)d.set(a[e].node,"");let t=d.get(l);d.set(l,t.substring(0,c)+n)}}for(const e of i){const t=d.get(e);e.nodeValue!==t&&(e.nodeValue=t)}(0,o.showProcessingIndicator)(!1)}function c(e){if(e.nodeType!==Node.TEXT_NODE){if(e.nodeType===Node.ELEMENT_NODE&&"script"!==e.tagName.toLowerCase()&&"style"!==e.tagName.toLowerCase()){if(e.classList.contains("wtr-replacer-ui"))return;for(const t of e.childNodes)c(t)}}else n.state.originalTextNodes.has(e)&&(e.nodeValue=n.state.originalTextNodes.get(e))}},949:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.changeDupGroup=function(e){n.state.currentDupIndex=Math.max(0,Math.min(n.state.dupKeys.length-1,n.state.currentDupIndex+e)),(0,a.renderTermList)()},t.computeDupGroups=o,t.exitDupMode=s,t.updateDupModeAfterChange=function(){if(o(n.state.terms),0===n.state.dupKeys.length)return alert("All duplicates resolved."),void s();const e=n.state.dupKeys[n.state.currentDupIndex],t=n.state.dupKeys.indexOf(e);if(-1!==t){const r=n.state.dupGroups.get(e);r&&(r.length>1||e.startsWith("Internal duplicate"))?n.state.currentDupIndex=t:n.state.currentDupIndex=Math.min(n.state.currentDupIndex,n.state.dupKeys.length-1)}else n.state.currentDupIndex=Math.min(n.state.currentDupIndex,n.state.dupKeys.length-1);(0,a.renderTermList)()};var n=r(730),a=r(433);function o(e){const t=new Map,r=new Map,a=new Map;e.forEach(e=>{const n=function(e){const t=[],r=e.original;return e.isRegex&&!/[\\^$.*+?()[\]{}()]/.test(r)?t.push(...r.split("|")):t.push(r),t.map(t=>{let r=t.trim().replace(/\s+/g," ");return e.caseSensitive||(r=r.toLowerCase()),r}).filter(e=>e.length>0)}(e);if(n.length>1&&new Set(n).size<n.length){const t=`Internal duplicate in: "${e.original.length>50?e.original.substring(0,47)+"...":e.original}"`;a.set(t,[e])}if(n.forEach(r=>{t.has(r)||t.set(r,[]);const n=t.get(r);n.some(t=>t.id===e.id)||n.push(e)}),e.replacement){const t=e.replacement;r.has(t)||r.set(t,[]),r.get(t).push(e)}});for(const[e,r]of t.entries())r.length>1&&a.set(`Original component: "${e}"`,r);for(const[e,t]of r.entries())if(t.length>1){const r=`Replacement: "${e}"`;if(a.has(r)){const e=a.get(r),n=t.filter(t=>!e.some(e=>e.id===t.id));a.set(r,[...e,...n])}else a.set(r,t)}n.state.dupGroups=a,n.state.dupKeys=Array.from(n.state.dupGroups.keys()).sort()}function s(){n.state.isDupMode=!1,n.state.currentDupIndex=0,n.state.dupGroups=new Map,n.state.dupKeys=[],(0,a.renderTermList)(n.state.currentSearchValue)}}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,r),o.exports}var n=r(433),a=r(310),o=r(361),s=r(730),l=c(r(170)),i=r(58);function c(e,t){if("function"==typeof WeakMap)var r=new WeakMap,n=new WeakMap;return(c=function(e,t){if(!t&&e&&e.__esModule)return e;var a,o,s={__proto__:null,default:e};if(null===e||"object"!=typeof e&&"function"!=typeof e)return s;if(a=t?n:r){if(a.has(e))return a.get(e);a.set(e,s)}for(const t in e)"default"!==t&&{}.hasOwnProperty.call(e,t)&&((o=(a=Object.defineProperty)&&Object.getOwnPropertyDescriptor(e,t))&&(o.get||o.set)?a(s,t,o):s[t]=e[t]);return s})(e,t)}(async function(){(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Main function starting initialization...");const e=(0,i.getNovelSlug)();if(!e)return(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Critical error - could not determine novel slug"),void console.error("WTR Term Replacer: Could not determine novel slug.");(0,i.log)(s.state.globalSettings,`WTR Term Replacer: Novel slug determined: ${e}`),(0,s.setNovelSlug)(e),(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Loading global settings and data..."),await(0,a.loadGlobalSettings)(),await(0,a.loadData)(),(0,i.log)(s.state.globalSettings,`WTR Term Replacer: Data loaded - terms: ${s.state.terms.length}, settings disabled: ${s.state.settings.isDisabled}`),(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Setting up error handling..."),window.addEventListener("error",e=>{e.error&&e.error.message&&e.error.message.includes("WTR")&&(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Caught error:",e.error)}),window.addEventListener("unhandledrejection",e=>{e.reason&&e.reason.message&&e.reason.message.includes("WTR")&&(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Unhandled promise rejection:",e.reason)}),window.addEventListener("beforeunload",()=>{s.state.processingQueue.clear(),(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Cleanup on page unload")}),(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Enhanced error handling activated"),(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Setting up disable functionality..."),l.handleDisableToggle=async function(e){const t=s.state.settings.isDisabled,n=e.target.checked;s.state.settings.isDisabled=n,await(await Promise.resolve().then(()=>c(r(310)))).saveSettings(s.state.settings);const a=function(){const e=window.location.href.match(/(chapter-\d+)/);return e?e[1]:null}();if(!a)return;const o=`#${a} .chapter-body`,l=document.querySelector(o);if(l)try{const{performReplacements:e,revertAllReplacements:t}=await Promise.resolve().then(()=>c(r(921)));n?((0,i.log)(s.state.globalSettings,"WTR Term Replacer: Robust disable - reverting all replacements"),await t(l),l.dataset.wtrProcessed="false"):((0,i.log)(s.state.globalSettings,"WTR Term Replacer: Robust enable - performing replacements"),await e(l),l.dataset.wtrProcessed="true")}catch(r){(0,i.log)(s.state.globalSettings,`WTR Term Replacer: Error during ${n?"disable":"enable"} operation:`,r),e.target.checked=t,s.state.settings.isDisabled=t}},(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Enhanced disable functionality activated"),(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Setting up navigation handling..."),function(){let e=!1;const t=()=>{e?(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Navigation already in progress, skipping"):(e=!0,s.state.processingQueue.clear(),setTimeout(()=>{Promise.resolve().then(()=>c(r(361))).then(({processVisibleChapter:e})=>{e()}),e=!1},500))};window.addEventListener("popstate",()=>{(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Popstate event detected"),t()});const n=history.pushState,a=history.replaceState;history.pushState=function(...e){const r=n.apply(this,e);return t(),r},history.replaceState=function(...e){const r=a.apply(this,e);return t(),r},(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Enhanced navigation handling activated")}(),(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Creating UI and menu commands..."),(0,n.createUI)(),(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Registering menu commands..."),GM_registerMenuCommand("Term Replacer Settings",l.showUIPanel),GM_registerMenuCommand("Toggle Logging",l.toggleLogging),(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Starting initial content detection..."),(0,o.waitForInitialContent)(),(0,i.log)(s.state.globalSettings,"WTR Term Replacer: Initialization completed successfully")})().catch(e=>console.error("WTR Term Replacer failed to start:",e)),window.addEventListener("wtr:addTerm",e=>{const{original:t,replacement:r,isRegex:n}=e.detail;l.addTermProgrammatically(t,r,n)})})();