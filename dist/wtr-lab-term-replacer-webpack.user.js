// ==UserScript==
// @name WTR Lab Term Replacer
// @description A modular, Webpack-powered version of the WTR Lab Term Replacer userscript.
// @version 5.4.4
// @author MasuRii
// @homepage https://github.com/MasuRii/wtr-lab-term-replacer-webpack#readme
// @supportURL https://github.com/MasuRii/wtr-lab-term-replacer-webpack/issues
// @match https://wtr-lab.com/en/novel/*/*/*
// @connect fonts.googleapis.com
// @downloadURL https://github.com/MasuRii/wtr-lab-term-replacer-webpack#readme/raw/main/dist/wtr-lab-term-replacer-webpack.5.4.4.performance.user.js
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_listValues
// @grant GM_addStyle
// @grant GM_registerMenuCommand
// @icon https://www.google.com/s2/favicons?sz=64&domain=wtr-lab.com
// @license MIT
// @namespace http://tampermonkey.net/
// @run-at document-idle
// @updateURL https://github.com/MasuRii/wtr-lab-term-replacer-webpack#readme/raw/main/dist/wtr-lab-term-replacer-webpack.5.4.4.performance.meta.js
// ==/UserScript==

(()=>{var e={70:(e,t,r)=>{"use strict";r.d(t,{performReplacements:()=>s,revertAllReplacements:()=>m});var n=r(907),a=r(395),o=r(314),l=r(194);async function s(e){if(e){if((0,a.Rm)(n.wk.globalSettings,"WTR Term Replacer: Starting performReplacements"),(0,o.gn)(!0),await new Promise(e=>setTimeout(e,10)),n.wk.settings.isDisabled||0===n.wk.terms.length)return(0,a.Rm)(n.wk.globalSettings,`WTR Term Replacer: Skipping replacements - disabled: ${n.wk.settings.isDisabled}, terms: ${n.wk.terms.length}`),void(0,o.gn)(!1);try{(0,a.Rm)(n.wk.globalSettings,`WTR Term Replacer: Found ${n.wk.terms.length} terms to process, beginning replacement with retry mechanism`),await async function(e){let t=null,r=0;(0,a.Rm)(n.wk.globalSettings,"WTR Term Replacer: Starting replacement process with 3 retries");for(let o=1;o<=3;o++)try{if((0,a.Rm)(n.wk.globalSettings,`WTR Term Replacer: Replacement attempt ${o}/3`),!i(e,r)){(0,a.Rm)(n.wk.globalSettings,`WTR Term Replacer: Element stability check failed, attempt ${r}`);const t=(0,a.Ug)(window.location.href);if(!t)throw(0,a.Rm)(n.wk.globalSettings,"WTR Term Replacer: Cannot determine chapter ID for element recovery"),new Error("Cannot determine chapter ID for element recovery");{const o=`#${t} ${l.tA}`;if(!(e=document.querySelector(o)))throw(0,a.Rm)(n.wk.globalSettings,`WTR Term Replacer: Unable to re-acquire target element for chapter ${t}`),new Error("Unable to re-acquire target element");(0,a.Rm)(n.wk.globalSettings,`WTR Term Replacer: Re-acquired target element for chapter ${t}`),r++}}if(!document.contains(e)||!e.parentNode)throw(0,a.Rm)(n.wk.globalSettings,"WTR Term Replacer: Target element validation failed - not in stable DOM"),new Error("Target element not in stable DOM");return(0,a.Rm)(n.wk.globalSettings,"WTR Term Replacer: Element validation passed, executing replacement logic"),await c(e),void(0,a.Rm)(n.wk.globalSettings,`WTR Term Replacer: Replacement attempt ${o} successful`)}catch(e){if(t=e,(0,a.Rm)(n.wk.globalSettings,`WTR Term Replacer: Replacement attempt ${o} failed:`,e.message),o<3){const t=Math.min(100*Math.pow(2,o-1),2e3);(0,a.Rm)(n.wk.globalSettings,`WTR Term Replacer: Retrying in ${t}ms...`),await new Promise(e=>setTimeout(e,t)),e.message&&e.message.includes("DOM")&&r++}else(0,a.Rm)(n.wk.globalSettings,"WTR Term Replacer: All 3 attempts failed, giving up")}throw(0,a.Rm)(n.wk.globalSettings,`WTR Term Replacer: All replacement attempts failed, throwing error: ${t?.message||"Unknown error"}`),t||new Error("Unknown replacement error")}(e)}catch(e){(0,a.Rm)(n.wk.globalSettings,"WTR Term Replacer: Failed to perform replacements after retries:",e),console.error("WTR Term Replacer: Replacement failed, but original content preserved")}finally{(0,o.gn)(!1),(0,a.Rm)(n.wk.globalSettings,"WTR Term Replacer: performReplacements completed")}}else(0,a.Rm)(n.wk.globalSettings,"WTR Term Replacer: performReplacements called with null target element")}function i(e,t){if(!e||!document.contains(e))return!1;const r=e.getBoundingClientRect();if(0===r.width||0===r.height)return!1;let n=e.parentNode,a=0;for(;n&&a<10;){if(!document.contains(n))return!1;n=n.parentNode,a++}return t<3}async function c(e){if(!e||e.nodeType!==Node.ELEMENT_NODE)throw new Error("Invalid target element");if(!i(e,0))throw new Error("Target element DOM stability check failed");if(0===(e.textContent?.trim()||"").length){const t=(0,a.Ug)(window.location.href)||"unknown",r=e.textContent?.length||0;return void(0,a.Rm)(n.wk.globalSettings,`WTR Term Replacer: Target element has no text content in chapter ${t} (${r} chars), skipping`)}const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),r=[];let l;for(;l=t.nextNode();)l.parentElement.closest(".wtr-replacer-ui, script, style")||r.push(l);const s=new Map,c=[];let d="",m=0;if(r.forEach(e=>{n.wk.originalTextNodes.has(e)||n.wk.originalTextNodes.set(e,e.nodeValue);const t=n.wk.originalTextNodes.get(e);s.set(e,t),t.length>0&&c.push({node:e,start:m,end:m+t.length}),d+=t,m+=t.length}),!d.trim())return void(0,o.gn)(!1);const p=new Map,g=new Map,u=new Map,w=new Map,b=[];for(const e of n.wk.terms)if(e.original)if(e.isRegex)try{const t=e.caseSensitive?"g":"gi";b.push({pattern:new RegExp(e.original,t),replacement:e.replacement})}catch(t){console.error(`Skipping invalid regex for term "${e.original}":`,t)}else{const t=e.caseSensitive?e.original:e.original.toLowerCase(),r=e.replacement;e.caseSensitive?e.wholeWord?g.set(t,r):p.set(t,r):e.wholeWord?w.set(t,r):u.set(t,r)}const f=[...b],h=(e,t,r,n)=>{if(e.size>0){const o=[...e.keys()].sort((e,t)=>t.length-e.length).map(e=>{const t=(0,a.Nt)(e);return r?`\\b${t}\\b`:t}).join("|");f.push({pattern:new RegExp(o,t),replacement_map:e,is_simple:!0,case_sensitive:n})}};h(p,"g",!1,!0),h(g,"g",!0,!0),h(u,"gi",!1,!1),h(w,"gi",!0,!1);const R=[];for(const e of f)for(const t of d.matchAll(e.pattern)){if(t.index===t.index+t[0].length)continue;let r;if(e.is_simple){const n=e.case_sensitive?t[0]:t[0].toLowerCase();r=e.replacement_map.get(n)}else r=e.replacement;void 0!==r&&R.push({start:t.index,end:t.index+t[0].length,replacement:r})}R.sort((e,t)=>e.start!==t.start?e.start-t.start:t.end-e.end);const k=[];let v=-1;for(const e of R)e.start>=v&&(k.push(e),v=e.end);for(const e of k.reverse()){const{start:t,end:r,replacement:n}=e,a=[];for(const e of c)e.start<r&&e.end>t&&a.push(e);if(0===a.length)continue;const o=a[0],l=a[a.length-1],i=o.node,d=l.node,m=t-o.start,p=r-l.start;if(i===d){const e=s.get(i);s.set(i,e.substring(0,m)+n+e.substring(p))}else{const e=s.get(d);s.set(d,e.substring(p));for(let e=1;e<a.length-1;e++)s.set(a[e].node,"");const t=s.get(i);s.set(i,t.substring(0,m)+n)}}for(const e of r){const t=s.get(e);e.nodeValue!==t&&(e.nodeValue=t)}(0,o.gn)(!1)}function d(e){if(e.nodeType!==Node.TEXT_NODE){if(e.nodeType===Node.ELEMENT_NODE&&"script"!==e.tagName.toLowerCase()&&"style"!==e.tagName.toLowerCase()){if(e.classList.contains("wtr-replacer-ui"))return;for(const t of e.childNodes)d(t)}}else n.wk.originalTextNodes.has(e)&&(e.nodeValue=n.wk.originalTextNodes.get(e))}async function m(e){e&&((0,o.gn)(!0),await new Promise(e=>setTimeout(e,10)),d(e),(0,o.gn)(!1))}},194:(e,t,r)=>{"use strict";r.d(t,{Ft:()=>o,Qp:()=>s,fW:()=>a,re:()=>i,sI:()=>l,tA:()=>n});const n=".chapter-body",a="wtr_lab_terms_",o="wtr_lab_settings_",l="wtr_lab_global_settings",s="wtr_lab_term_list_location",i=100},206:(e,t,r)=>{"use strict";r.d(t,{J:()=>g,_:()=>s,processVisibleChapter:()=>i});var n=r(907),a=r(70),o=r(314),l=r(395);function s(){(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: Starting robust content detection for slow-loading websites..."),(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: Setting up content change observer"),function(){let e,t=0,r=!1,a=0;new MutationObserver(o=>{const s=Date.now();if(s-t<2e3)return;let c=!1;const d=[];for(const e of o)if("childList"===e.type&&e.addedNodes.length>0)for(const t of e.addedNodes)if(t.nodeType===Node.ELEMENT_NODE){const e=t.textContent?.trim()||"";if(t.hasAttribute?.("data-smart-quotes-processed")&&(d.push("Smart Quotes"),c=!0),t.hasAttribute?.("data-uncensor-processed")&&(d.push("Uncensor"),c=!0),(t.hasAttribute?.("data-auto-scroll")||t.hasAttribute?.("data-reader-enhanced"))&&(d.push("Reader Enhancer"),c=!0),e.length>100&&!e.includes("loading")&&!e.includes("...")&&(t.id?.includes("chapter")||t.className?.includes("chapter")||t.querySelector(".chapter-body"))){c=!0;break}}if(c&&!r){r=!0,t=s,d.length>0?(a++,(0,l.Rm)(`WTR Term Replacer: Multi-script activity detected from: ${d.join(", ")} (conflict ${a})`),d.forEach(e=>n.wk.otherWTRScripts.add(e))):(0,l.Rm)("WTR Term Replacer: Content changes detected, checking for chapter content...");const o=1500,c=n.wk.otherWTRScripts.size>0?2500:o;clearTimeout(e),e=setTimeout(()=>{document.querySelector("[data-wtr-processed]")||n.wk.processingQueue.size>0?(0,l.Rm)(`WTR Term Replacer: Skipping content processing - already in progress or completed (queue: ${n.wk.processingQueue.size})`):((0,l.Rm)(`WTR Term Replacer: Initiating content processing (${n.wk.otherWTRScripts.size} other scripts active, ${c}ms coordination delay)`),i()),r=!1},c)}}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class","id"]}),(0,l.Rm)("WTR Term Replacer: Enhanced content observer activated with multi-script coordination")}(),(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: Setting up fallback detection mechanisms"),function(){let e=0;const t=setInterval(()=>{if(document.querySelector("[data-wtr-processed]"))return void clearInterval(t);e++,(0,l.Rm)(`WTR Term Replacer: Fallback attempt ${e}/10`);const r=(0,l.Ug)(window.location.href);if(r){const e=`#${r} .chapter-body`;if(document.querySelector(e))return(0,l.Rm)("WTR Term Replacer: Fallback processing successful"),i(),void clearInterval(t)}const n=document.querySelector("main, article, .content, .chapter");n&&n.textContent?.trim().length>200&&((0,l.Rm)("WTR Term Replacer: Fallback processing with detected content"),i(),clearInterval(t)),e>=10&&(clearInterval(t),(0,l.Rm)("WTR Term Replacer: Fallback detection exhausted"))},3e3);setTimeout(()=>{clearInterval(t)},3e5)}()}function i(){const e=(0,l.Ug)(window.location.href);if(!e)return;const t=`#${e} .chapter-body`,r=document.querySelector(t);r&&"true"!==r.dataset.wtrProcessed&&c(e)}function c(e,t){const r=`${e}_${Date.now()}`;n.wk.processingQueue.has(e)?(0,l.Rm)(`WTR Term Replacer: Chapter ${e} already queued for processing ${n.wk.processingQueue.size} queued`):(n.wk.processingQueue.add(r),d(e,[{delay:100,maxContentLoad:.3},{delay:500,maxContentLoad:.5},{delay:1e3,maxContentLoad:.7},{delay:2e3,maxContentLoad:.9},{delay:5e3,maxContentLoad:1}],0,r))}async function d(e,t,r,a){const o=t[r];try{if(await new Promise(e=>setTimeout(e,o.delay)),!n.wk.processingQueue.has(a))return void(0,l.Rm)(`WTR Term Replacer: Chapter ${e} processing cancelled (no longer in queue)`);const s=`#${e} .chapter-body`,i=document.querySelector(s);if(!i)throw new Error("Chapter body element not found");if(!document.contains(i)||i.nodeType!==Node.ELEMENT_NODE)throw new Error("Chapter body element no longer in DOM");const c=function(e){const t=e.querySelectorAll("p, h1, h2, h3, h4, h5, h6, div, span"),r=Array.from(t).reduce((e,t)=>e+(t.textContent?.trim().length||0),0),n=e.querySelector('.loading, .spinner, [style*="loading"], [class*="loading"]'),a=e.textContent?.includes("Loading...")||e.textContent?.includes("loading")||e.textContent?.includes("...");let o=Math.min(r/1e3,1);return(n||a)&&(o*=.3),Math.max(o,r>100?.5:.1)}(i);c>=o.maxContentLoad?(await p(i,e),n.wk.processingQueue.delete(a),(0,l.Rm)(`WTR Term Replacer: Successfully processed chapter ${e} on attempt ${r+1}`)):r<t.length-1?((0,l.Rm)(`WTR Term Replacer: Chapter ${e} content not ready (load level: ${c.toFixed(2)}), retrying...`),d(e,t,r+1,a)):((0,l.Rm)(`WTR Term Replacer: Final attempt for chapter ${e} with available content`),await p(i,e,!0),n.wk.processingQueue.delete(a))}catch(o){(0,l.Rm)(`WTR Term Replacer: Error processing chapter ${e} on attempt ${r+1}:`,o),r<t.length-1?d(e,t,r+1,a):(n.wk.processingQueue.delete(a),console.error(`WTR Term Replacer: Failed to process chapter ${e} after all retries`))}}function m(e,t){const r=n.wk.processingStartTime.get(e);if(r){const a=Date.now()-r,o=n.wk.otherWTRScripts.size>0;return(0,l.Rm)(n.wk.globalSettings,`WTR Term Replacer: Processing timer ended for ${e}, took ${a}ms`),function(e,t,r=!1){const a={chapterId:e,processingTime:`${t}ms`,multiScriptEnvironment:r,activeScripts:n.wk.otherWTRScripts.size,queueSize:n.wk.processingQueue.size,timestamp:(new Date).toISOString()};r&&n.wk.otherWTRScripts.size>0?(a.activeScripts=Array.from(n.wk.otherWTRScripts),(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: Multi-script enhanced processing completed",a)):(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: Standard processing completed",a)}(t,a,o),n.wk.processingStartTime.delete(e),a}return(0,l.Rm)(n.wk.globalSettings,`WTR Term Replacer: Warning - processing timer for ${e} not found`),0}async function p(e,t,r=!1){try{if(!r&&!function(e){const t=e.getBoundingClientRect(),r=t.width>0&&t.height>0,n=e.textContent?.trim().length>50,a=!e.querySelector('.loading, .spinner, [style*="display: none"]');return r&&n&&a}(e))throw new Error("Element not ready for processing");s=`chapter_${t}`,(0,l.Rm)(n.wk.globalSettings,`WTR Term Replacer: Starting processing timer for ${s}`),n.wk.processingStartTime.set(s,Date.now()),0===n.wk.otherWTRScripts.size&&function(){(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: Scanning for other WTR Lab scripts...");const e=document.querySelectorAll("[data-smart-quotes-processed], [data-uncensor-processed], [data-auto-scroll], [data-reader-enhanced]");(0,l.Rm)(n.wk.globalSettings,`WTR Term Replacer: Found ${e.length} elements with WTR script attributes`),e.forEach(e=>{e.hasAttribute("data-smart-quotes-processed")&&(n.wk.otherWTRScripts.add("Smart Quotes"),(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: Detected Smart Quotes script")),e.hasAttribute("data-uncensor-processed")&&(n.wk.otherWTRScripts.add("Uncensor"),(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: Detected Uncensor script")),(e.hasAttribute("data-auto-scroll")||e.hasAttribute("data-reader-enhanced"))&&(n.wk.otherWTRScripts.add("Reader Enhancer"),(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: Detected Reader Enhancer script"))}),n.wk.otherWTRScripts.size>0?(0,l.Rm)(n.wk.globalSettings,`WTR Term Replacer: Multi-script environment detected - Active scripts: ${Array.from(n.wk.otherWTRScripts).join(", ")}`):(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: No other WTR scripts detected, running in single-script mode")}();const i=n.wk.otherWTRScripts.size>0;i?(0,l.Rm)(`WTR Term Replacer: Multi-script processing starting for chapter ${t} with active scripts: ${Array.from(n.wk.otherWTRScripts).join(", ")}`):(0,l.Rm)(`WTR Term Replacer: Processing chapter ${t} with robust method`),(0,a.performReplacements)(e),e.dataset.wtrProcessed="true",(0,o.L_)();const c=m(`chapter_${t}`,t);i&&(0,l.Rm)(`WTR Term Replacer: Successfully completed multi-script processing for chapter ${t} in ${c}ms`)}catch(e){const r=m(`chapter_${t}`,t)||0;throw(0,l.Rm)(`WTR Term Replacer: Robust processing failed for chapter ${t} after ${r}ms:`,e),e}var s}function g(){const e=(0,l.Ug)(window.location.href);if(!e)return;const t=`#${e} .chapter-body`,r=document.querySelector(t);r&&(r.dataset.wtrProcessed="false",Array.from(n.wk.processingQueue).filter(t=>t.startsWith(e)).forEach(e=>n.wk.processingQueue.delete(e)),c(e))}},314:(e,t,r)=>{"use strict";r.d(t,{BD:()=>h,E1:()=>w,FP:()=>u,L_:()=>k,OG:()=>R,RD:()=>d,W4:()=>g,X:()=>b,Xt:()=>p,gn:()=>m,kH:()=>f});var n=r(907),a=r(349),o=r(494),l=r(395),s=r(194);const i=`\n    <div class="wtr-replacer-header">\n        <h2>Term Replacer ${(0,r(387).getDisplayVersion)()}</h2>\n        <div class="wtr-replacer-header-controls">\n            <div class="wtr-replacer-disable-toggle">\n                <label><input type="checkbox" id="wtr-disable-all"> Disable All</label>\n            </div>\n            <button class="wtr-replacer-close-btn">&times;</button>\n        </div>\n    </div>\n    <div class="wtr-replacer-tabs">\n        <button class="wtr-replacer-tab-btn active" data-tab="terms">Terms List</button>\n        <button class="wtr-replacer-tab-btn" data-tab="add">Add/Edit Term</button>\n        <button class="wtr-replacer-tab-btn" data-tab="io">Import/Export</button>\n    </div>\n    <div class="wtr-replacer-content">\n        <div class="wtr-ui-loader" id="wtr-ui-loader">Loading...</div>\n        <div id="wtr-tab-terms" class="wtr-replacer-tab-content active">\n            <div id="wtr-dup-message" class="wtr-dup-message" style="display:none;"></div>\n            <div id="wtr-dup-controls" class="wtr-dup-controls" style="display:none;">\n                <button id="wtr-prev-dup-btn" class="btn btn-secondary">Previous</button>\n                <button id="wtr-next-dup-btn" class="btn btn-secondary">Next</button>\n                <button id="wtr-exit-dup-btn" class="btn btn-secondary">Exit Duplicate Mode</button>\n            </div>\n            <div class="wtr-replacer-list-controls">\n                <input type="text" id="wtr-search-bar" class="wtr-replacer-search-bar" placeholder="Search terms...">\n                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">\n                    <button id="wtr-find-duplicates-btn" class="btn btn-secondary">Find Duplicates</button>\n                    <button id="wtr-delete-selected-btn" class="btn btn-secondary">Delete Selected</button>\n                </div>\n            </div>\n            <ul class="wtr-replacer-term-list"></ul>\n            <div class="wtr-pagination-controls">\n                <button id="wtr-first-page-btn" class="btn btn-secondary" title="First Page">&laquo;&laquo;</button>\n                <button id="wtr-prev-page-btn" class="btn btn-secondary" title="Previous Page">&laquo;</button>\n                <span id="wtr-page-indicator"></span>\n                <button id="wtr-next-page-btn" class="btn btn-secondary" title="Next Page">&raquo;</button>\n                <button id="wtr-last-page-btn" class="btn btn-secondary" title="Last Page">&raquo;&raquo;</button>\n            </div>\n        </div>\n        <div id="wtr-tab-add" class="wtr-replacer-tab-content">\n            <input type="hidden" id="wtr-term-id">\n            <div class="wtr-replacer-form-group">\n                <label for="wtr-original">Original Text</label>\n                <textarea id="wtr-original" rows="1"></textarea>\n            </div>\n            <div class="wtr-replacer-form-group">\n                <label for="wtr-replacement">Replacement Text</label>\n                <input type="text" id="wtr-replacement">\n            </div>\n            <div class="wtr-replacer-form-group">\n                <label><input type="checkbox" id="wtr-case-sensitive"> Case Sensitive</label>\n                <label><input type="checkbox" id="wtr-is-regex"> Use Regex</label>\n                <label><input type="checkbox" id="wtr-whole-word" disabled> Whole Word Only</label>\n            </div>\n            <button id="wtr-save-btn" class="btn btn-primary">Save Term</button>\n        </div>\n        <div id="wtr-tab-io" class="wtr-replacer-tab-content">\n            <input type="file" id="wtr-file-input" accept=".json" style="display: none;">\n            <div class="wtr-replacer-io-section">\n                <h3>Export</h3>\n                <div class="wtr-replacer-io-actions" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">\n                    <button id="wtr-export-novel-btn" class="btn btn-success">Export Novel Terms</button>\n                    <button id="wtr-export-all-btn" class="btn btn-success">Export All Terms</button>\n                    <button id="wtr-export-combined-btn" class="btn btn-info wtr-export-combined">Export Both (Novel + All)</button>\n                </div>\n            </div>\n            <div class="wtr-replacer-io-section">\n                <h3>Import</h3>\n                <div class="wtr-replacer-io-actions" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">\n                    <button id="wtr-import-novel-btn" class="btn btn-warning">Import to This Novel</button>\n                    <button id="wtr-import-all-btn" class="btn btn-warning">Import All (Global)</button>\n                </div>\n            </div>\n        </div>\n    </div>\n`,c="\n    /* --- Google Material Symbols --- */\n    @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0');\n    \n    .material-symbols-outlined {\n        font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;\n        font-size: 16px;\n        vertical-align: middle;\n    }\n\n    /* --- Main UI Container --- */\n    .wtr-replacer-ui {\n        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);\n        width: 90%; max-width: 650px; max-height: 80vh;\n        background-color: var(--bs-body-bg); color: var(--bs-body-color);\n        border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius-lg);\n        box-shadow: var(--bs-box-shadow-lg); z-index: 99999;\n        display: none; flex-direction: column; font-family: var(--bs-body-font-family);\n    }\n    .wtr-replacer-ui * { box-sizing: border-box; }\n\n    /* --- Header --- */\n    .wtr-replacer-header {\n        padding: 0.75rem 1rem; background-color: var(--bs-tertiary-bg);\n        border-bottom: 1px solid var(--bs-border-color);\n        display: flex; justify-content: space-between; align-items: center;\n        border-radius: var(--bs-border-radius-lg) var(--bs-border-radius-lg) 0 0;\n    }\n    .wtr-replacer-header h2 { margin: 0; font-size: 1.25rem; }\n    .wtr-replacer-header-controls { display: flex; align-items: center; gap: 1rem; }\n    .wtr-replacer-disable-toggle label { display: flex; align-items: center; cursor: pointer; font-size: 0.9rem; }\n    .wtr-replacer-disable-toggle input { margin-right: 0.5rem; }\n    .wtr-replacer-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; line-height: 1; color: inherit; padding: 0; }\n\n    /* --- Tabs --- */\n    .wtr-replacer-tabs { display: flex; padding: 0 0.5rem; border-bottom: 1px solid var(--bs-border-color); background-color: var(--bs-tertiary-bg); }\n    .wtr-replacer-tab-btn {\n        background: none; border: none; padding: 0.75rem 1rem; cursor: pointer;\n        font-size: 0.9rem; color: var(--bs-secondary-color);\n        border-bottom: 3px solid transparent; margin-bottom: -1px;\n    }\n    .wtr-replacer-tab-btn.active { color: var(--bs-primary); border-bottom-color: var(--bs-primary); font-weight: bold; }\n\n    /* --- Content & Forms --- */\n    .wtr-replacer-content { padding: 1rem; overflow-y: auto; flex-grow: 1; position: relative; }\n    .wtr-replacer-tab-content { display: none; }\n    .wtr-replacer-tab-content.active { display: block; }\n    .wtr-replacer-form-group { margin-bottom: 1rem; }\n    .wtr-replacer-form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; font-size: 0.9rem; }\n    .wtr-replacer-form-group input[type=\"text\"], .wtr-replacer-search-bar {\n        width: 100%; padding: 0.5rem 0.75rem;\n        background-color: var(--bs-body-bg); color: var(--bs-body-color);\n        border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius);\n    }\n    .wtr-replacer-form-group textarea {\n        width: 100%; padding: 0.5rem 0.75rem;\n        background-color: var(--bs-body-bg); color: var(--bs-body-color);\n        border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius);\n        resize: none;\n        min-height: 2.5rem; max-height: 10rem;\n        line-height: 1.5; font-family: inherit;\n        word-wrap: break-word; white-space: pre-wrap;\n    }\n    .wtr-replacer-form-group input[type=\"checkbox\"] { margin-right: 0.5rem; }\n\n    /* --- Visual Validation States --- */\n    .wtr-replacer-form-group .wtr-field-invalid {\n        border-color: var(--bs-danger) !important;\n        background-color: rgba(var(--bs-danger-rgb), 0.1) !important;\n        box-shadow: 0 0 0 0.2rem rgba(var(--bs-danger-rgb), 0.25);\n    }\n    \n    .wtr-replacer-form-group .wtr-field-valid {\n        border-color: var(--bs-success) !important;\n        background-color: rgba(var(--bs-success-rgb), 0.1) !important;\n    }\n    \n    .wtr-save-btn:disabled {\n        opacity: 0.6;\n        cursor: not-allowed;\n        background-color: var(--bs-secondary);\n        border-color: var(--bs-secondary);\n    }\n\n    /* --- Buttons (Scoped to UI) --- */\n    .wtr-replacer-ui .btn {\n        display: inline-block; font-weight: 400; line-height: 1.5; color: var(--bs-body-color);\n        text-align: center; vertical-align: middle; cursor: pointer; user-select: none;\n        background-color: transparent; border: 1px solid transparent;\n        padding: 0.375rem 0.75rem; font-size: 1rem; border-radius: var(--bs-border-radius);\n        transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;\n    }\n    .wtr-replacer-ui .btn:disabled { opacity: 0.65; cursor: not-allowed; }\n    .wtr-replacer-ui .btn-primary { color: #fff; background-color: var(--bs-primary); border-color: var(--bs-primary); }\n    .wtr-replacer-ui .btn-secondary { color: #fff; background-color: var(--bs-secondary); border-color: var(--bs-secondary); }\n    .wtr-replacer-ui .btn-success { color: #fff; background-color: var(--bs-success); border-color: var(--bs-success); }\n    .wtr-replacer-ui .btn-warning { color: #000; background-color: var(--bs-warning); border-color: var(--bs-warning); }\n    .wtr-replacer-ui .btn-info { color: #fff; background-color: var(--bs-info); border-color: var(--bs-info); }\n\n    /* --- Term List --- */\n    .wtr-replacer-list-controls {\n        display: flex; justify-content: space-between; align-items: center;\n        gap: 0.75rem; position: sticky; top: -1rem;\n        background-color: var(--bs-body-bg); padding: 0.75rem 0; z-index: 10;\n        flex-wrap: wrap;\n    }\n    .wtr-replacer-term-list { list-style: none; padding: 0; margin: 0; }\n    .wtr-replacer-term-item {\n        padding: 0.75rem; border: 1px solid var(--bs-border-color);\n        border-radius: var(--bs-border-radius); margin-bottom: 0.5rem;\n        display: flex; align-items: center; gap: 0.75rem;\n        background-color: var(--bs-secondary-bg-subtle);\n    }\n    .wtr-replacer-term-details { flex-grow: 1; overflow: hidden; }\n    .wtr-replacer-term-text { font-family: var(--bs-font-monospace); font-size: 0.9rem; word-wrap: break-word; }\n    .wtr-term-original { color: var(--bs-danger) !important; font-weight: bold; }\n    .wtr-term-replacement { color: var(--bs-success) !important; font-weight: bold; }\n\n    /* --- Floating Button --- */\n    .wtr-add-term-float-btn {\n        position: fixed; bottom: 20px; right: 20px;\n        background-color: var(--bs-primary); color: white;\n        padding: 0.75rem 1.25rem; border-radius: 50rem; border: none;\n        box-shadow: var(--bs-box-shadow); cursor: pointer; font-size: 1rem; z-index: 99998; display: none;\n    }\n\n    /* --- Overlays & Loaders --- */\n    .wtr-processing-overlay {\n        position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n        background: rgba(0,0,0,0.5); color: white;\n        display: flex; justify-content: center; align-items: center;\n        font-size: 1.5rem; z-index: 100000; display: none;\n    }\n    .wtr-ui-loader {\n        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;\n        background: rgba(var(--bs-body-bg-rgb), 0.7); color: var(--bs-body-color);\n        justify-content: center; align-items: center; z-index: 20;\n    }\n\n    /* --- Duplicate Mode & Pagination --- */\n    .wtr-dup-message { margin-bottom: 0.75rem; font-weight: bold; }\n    .wtr-dup-controls { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }\n    .wtr-pagination-controls {\n        display: flex; justify-content: center; align-items: center; margin-top: 1rem; gap: 0.25rem;\n        flex-wrap: wrap; padding: 0.5rem 0;\n    }\n    .wtr-pagination-controls .btn {\n        padding: 0.25rem 0.5rem; font-size: 0.875rem; min-width: 2.5rem;\n    }\n    #wtr-page-indicator {\n        white-space: nowrap; margin: 0 0.5rem; font-size: 0.875rem;\n        padding: 0.25rem 0.5rem; background-color: var(--bs-secondary-bg-subtle);\n        border-radius: var(--bs-border-radius);\n    }\n\n    /* --- Enhanced Export Button Styling --- */\n    .wtr-export-combined {\n        background: linear-gradient(45deg, var(--bs-success), #28a745);\n        border: none;\n        color: white;\n        font-weight: bold;\n        position: relative;\n        overflow: hidden;\n    }\n\n    .wtr-export-combined:hover {\n        background: linear-gradient(45deg, #28a745, var(--bs-success));\n        transform: translateY(-1px);\n        box-shadow: 0 4px 8px rgba(0,0,0,0.2);\n    }\n\n    .wtr-export-combined:active {\n        transform: translateY(0);\n    }\n\n    /* --- Global Menu Button Alignment Fix --- */\n    /* Fix menu button alignment - remove margin-right from Term Settings for all devices */\n    .bottom-reader-nav .menu-button.small > span {\n        margin-right: 0 !important;\n    }\n\n    /* --- Responsive Design (Mobile First) --- */\n    #wtr-tab-terms.active {\n        display: flex;\n        flex-direction: column;\n    }\n    .wtr-replacer-list-controls { order: 1; }\n    .wtr-pagination-controls { order: 2; margin-top: 0.5rem; margin-bottom: 0.5rem; }\n    .wtr-replacer-term-list { order: 3; }\n\n    /* --- Mobile Specific Improvements --- */\n    @media (max-width: 768px) {\n\n        .wtr-replacer-ui {\n            width: 95%; max-height: 85vh;\n            top: 2.5%; left: 2.5%; transform: none;\n        }\n\n        .wtr-replacer-content {\n            padding: 0.5rem;\n        }\n\n        .wtr-replacer-list-controls {\n            flex-direction: column; align-items: stretch; gap: 0.5rem;\n        }\n\n        .wtr-replacer-list-controls input[type=\"text\"] {\n            order: 1;\n        }\n\n        .wtr-replacer-list-controls .btn {\n            order: 2; margin: 0;\n        }\n\n        .wtr-dup-controls {\n            justify-content: center;\n        }\n\n        .wtr-pagination-controls {\n            justify-content: center;\n            gap: 0.125rem;\n        }\n\n        .wtr-pagination-controls .btn {\n            padding: 0.375rem 0.5rem;\n            font-size: 0.8rem;\n            min-width: 2rem;\n        }\n\n        #wtr-page-indicator {\n            font-size: 0.8rem;\n            margin: 0 0.25rem;\n            padding: 0.25rem;\n        }\n\n        .wtr-replacer-term-item {\n            padding: 0.5rem;\n            gap: 0.5rem;\n        }\n\n        .wtr-replacer-term-text {\n            font-size: 0.8rem;\n        }\n    }\n\n    @media (min-width: 769px) {\n        .wtr-replacer-list-controls { order: 1; }\n        .wtr-replacer-term-list { order: 2; }\n        .wtr-pagination-controls { order: 3; margin-top: 1rem; margin-bottom: 0; }\n    }\n";function d(){if(document.querySelector(".wtr-replacer-ui"))return;GM_addStyle(c);const e=document.createElement("div");e.className="wtr-replacer-ui",e.innerHTML=i,document.body.appendChild(e);const t=document.createElement("div");t.className="wtr-processing-overlay",t.textContent="Processing...",document.body.appendChild(t),e.querySelector(".wtr-replacer-close-btn").addEventListener("click",a.X),e.querySelector("#wtr-disable-all").addEventListener("change",a.ts),e.querySelector("#wtr-save-btn").addEventListener("click",a.s7),e.querySelector("#wtr-delete-selected-btn").addEventListener("click",a.Jm),e.querySelector("#wtr-search-bar").addEventListener("input",a.RX),e.querySelector(".wtr-replacer-term-list").addEventListener("click",a.VM),e.querySelectorAll(".wtr-replacer-tab-btn").forEach(e=>e.addEventListener("click",a.Qk)),e.querySelector("#wtr-export-novel-btn").addEventListener("click",a.b7),e.querySelector("#wtr-export-all-btn").addEventListener("click",a.ym),e.querySelector("#wtr-export-combined-btn").addEventListener("click",a.ow),e.querySelector("#wtr-import-novel-btn").addEventListener("click",()=>{n.wk.importType="novel",document.getElementById("wtr-file-input").click()}),e.querySelector("#wtr-import-all-btn").addEventListener("click",()=>{n.wk.importType="all",document.getElementById("wtr-file-input").click()}),e.querySelector("#wtr-file-input").addEventListener("change",a.kF),e.querySelector("#wtr-find-duplicates-btn").addEventListener("click",a.y$),e.querySelector("#wtr-prev-dup-btn").addEventListener("click",()=>(0,o.DP)(-1)),e.querySelector("#wtr-next-dup-btn").addEventListener("click",()=>(0,o.DP)(1)),e.querySelector("#wtr-exit-dup-btn").addEventListener("click",o.bj);const r=e.querySelector(".wtr-replacer-content");if(r){let e;r.addEventListener("scroll",()=>{clearTimeout(e),e=setTimeout(()=>{"terms"===document.querySelector(".wtr-replacer-tab-btn.active").dataset.tab&&a.R6()},1e3)})}const d=e.querySelector("#wtr-is-regex"),m=e.querySelector("#wtr-whole-word");d.addEventListener("change",e=>{m.disabled=e.target.checked,e.target.checked&&(m.checked=!1)});const p=e.querySelector("#wtr-original");function g(){if(!p)return;const e=p.value.length,t=Math.ceil(e/40),r=Math.min(t,1/0);p.rows=Math.max(1,r)}p.addEventListener("input",g),p.addEventListener("focus",g);const w=e.querySelector("#wtr-save-btn"),b=e.querySelector("#wtr-replacement");function f(e){p.classList.remove("wtr-field-invalid","wtr-field-valid"),"invalid"===e?p.classList.add("wtr-field-invalid"):"valid"===e&&p.classList.add("wtr-field-valid")}function h(){const e=d.checked,t=p.value.trim(),r=b.value.trim(),n=t.length>0&&r.length>0;if(!e||0===t.length)return f(null),void(w.disabled=!n);a.fA(t).isValid?(f("valid"),w.disabled=!n):(f("invalid"),w.disabled=!0)}p.addEventListener("input",h),b.addEventListener("input",h),d.addEventListener("change",h),h();const R=document.createElement("button");R.className="wtr-add-term-float-btn",R.textContent="Add Term",document.body.appendChild(R),R.addEventListener("click",a.az),document.addEventListener("mouseup",a.Me),document.addEventListener("touchend",a.Me),e.querySelector("#wtr-first-page-btn").addEventListener("click",()=>{n.wk.currentPage>1&&(n.wk.currentPage=1,u(n.wk.currentSearchValue))}),e.querySelector("#wtr-prev-page-btn").addEventListener("click",()=>{n.wk.currentPage>1&&(n.wk.currentPage--,u(n.wk.currentSearchValue))}),e.querySelector("#wtr-next-page-btn").addEventListener("click",()=>{const e=n.wk.terms.filter(e=>e.original.toLowerCase().includes(n.wk.currentSearchValue.toLowerCase())||e.replacement.toLowerCase().includes(n.wk.currentSearchValue.toLowerCase())),t=Math.ceil(e.length/s.re)||1;n.wk.currentPage<t&&(n.wk.currentPage++,u(n.wk.currentSearchValue))}),e.querySelector("#wtr-last-page-btn").addEventListener("click",()=>{const e=n.wk.terms.filter(e=>e.original.toLowerCase().includes(n.wk.currentSearchValue.toLowerCase())||e.replacement.toLowerCase().includes(n.wk.currentSearchValue.toLowerCase())),t=Math.ceil(e.length/s.re)||1;n.wk.currentPage<t&&(n.wk.currentPage=t,u(n.wk.currentSearchValue))}),(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: UI created successfully")}function m(e){const t=document.querySelector(".wtr-processing-overlay");t&&(t.style.display=e?"flex":"none")}function p(){const e=document.getElementById("wtr-ui-loader");e&&(e.style.display="flex");const t=document.querySelector(".wtr-replacer-content");t&&(t.style.pointerEvents="none")}function g(){const e=document.getElementById("wtr-ui-loader");e&&(e.style.display="none");const t=document.querySelector(".wtr-replacer-content");t&&(t.style.pointerEvents="auto")}function u(e=""){const t=document.querySelector(".wtr-replacer-term-list"),r=document.querySelector(".wtr-pagination-controls"),a=document.getElementById("wtr-page-indicator"),o=document.getElementById("wtr-first-page-btn"),l=document.getElementById("wtr-prev-page-btn"),i=document.getElementById("wtr-next-page-btn"),c=document.getElementById("wtr-last-page-btn"),d=document.querySelector(".wtr-replacer-content");if(!(t&&r&&a&&l&&i&&o&&c))return;const m=d?d.scrollTop:0,p=m>0&&!n.wk.isDupMode&&e===n.wk.currentSearchValue;let g,u;if(t.innerHTML="",n.wk.isDupMode){const e=n.wk.dupKeys[n.wk.currentDupIndex];g=n.wk.dupGroups.get(e)||[],document.getElementById("wtr-dup-message").textContent=`Duplicate group ${n.wk.currentDupIndex+1} of ${n.wk.dupKeys.length} — ${e}`,document.getElementById("wtr-dup-message").style.display="block",document.getElementById("wtr-dup-controls").style.display="flex",document.getElementById("wtr-prev-dup-btn").disabled=0===n.wk.currentDupIndex,document.getElementById("wtr-next-dup-btn").disabled=n.wk.currentDupIndex===n.wk.dupKeys.length-1,document.getElementById("wtr-search-bar").disabled=!0,r.style.display="none",u=g}else{const t=e.toLowerCase();g=n.wk.terms.filter(e=>e.original.toLowerCase().includes(t)||e.replacement.toLowerCase().includes(t)),document.getElementById("wtr-dup-message").style.display="none",document.getElementById("wtr-dup-controls").style.display="none",document.getElementById("wtr-search-bar").disabled=!1;const d=Math.ceil(g.length/s.re)||1;n.wk.currentPage=Math.max(1,Math.min(n.wk.currentPage,d));const m=(n.wk.currentPage-1)*s.re,p=m+s.re;u=g.slice(m,p),d>1?(r.style.display="flex",a.textContent=`Page ${n.wk.currentPage} of ${d}`,o.disabled=1===n.wk.currentPage,l.disabled=1===n.wk.currentPage,i.disabled=n.wk.currentPage===d,c.disabled=n.wk.currentPage===d):r.style.display="none"}if(0===u.length)t.innerHTML=0===n.wk.terms.length?"<li>No terms defined.</li>":"<li>No terms match search.</li>";else{const e=document.createDocumentFragment();u.forEach(t=>{const r=document.createElement("li");r.className="wtr-replacer-term-item",r.dataset.id=t.id,r.innerHTML=`\n        <input type="checkbox" class="wtr-replacer-term-select" data-id="${t.id}">\n        <div class="wtr-replacer-term-details">\n          <div class="wtr-replacer-term-text">\n            <span class="wtr-term-original">${t.original}</span> → <span class="wtr-term-replacement">${t.replacement}</span>\n          </div>\n          <div>${t.caseSensitive?"<small>CS</small>":""} ${t.isRegex?"<small>RX</small>":""} ${t.wholeWord?"<small>WW</small>":""}</div>\n        </div>\n        <div><button class="btn btn-secondary btn-sm wtr-edit-btn" data-id="${t.id}">Edit</button></div>\n      `,e.appendChild(r)}),t.appendChild(e)}p&&d&&requestAnimationFrame(()=>{d.scrollTop=m})}function w(){document.querySelector(".wtr-replacer-ui").style.display="flex",document.getElementById("wtr-disable-all").checked=n.wk.settings.isDisabled,"terms"===document.querySelector(".wtr-replacer-tab-btn.active").dataset.tab?a.s3():u()}function b(){a.R6(),document.querySelector(".wtr-replacer-ui").style.display="none",f()}function f(){const e=document.querySelector(".wtr-replacer-term-list");e&&(e.innerHTML="")}function h(e=null){document.getElementById("wtr-term-id").value=e?e.id:"",document.getElementById("wtr-original").value=e?e.original:"",document.getElementById("wtr-replacement").value=e?e.replacement:"",document.getElementById("wtr-case-sensitive").checked=!!e&&e.caseSensitive,document.getElementById("wtr-is-regex").checked=!!e&&e.isRegex,document.getElementById("wtr-whole-word").checked=!!e&&e.wholeWord,document.getElementById("wtr-whole-word").disabled=!!e&&e.isRegex,document.getElementById("wtr-save-btn").textContent=e?"Update Term":"Save Term",R("add"),setTimeout(()=>{const e=document.getElementById("wtr-original");if(e){const t=e.value.length,r=Math.ceil(t/40);e.rows=Math.max(1,r)}if(document.getElementById("wtr-is-regex")){const t=new Event("input",{bubbles:!0});e.dispatchEvent(t)}},10)}function R(e){document.querySelector(`.wtr-replacer-tab-btn[data-tab="${e}"]`).click()}function k(){const e=document.querySelector("div.col-6:has(button.term-edit-btn)");if(!e||n.wk.observedMenuContainers.has(e))return;const t=()=>{let t=e.querySelector(".replacer-settings-btn");const r=e.querySelector(".term-edit-btn:not(.replacer-settings-btn)");if(!t){if(!r)return;t=function(e){const{text:t="Settings",onClick:r=null,className:n="",tooltip:a=""}=e,o=document.createElement("button");o.className=`replacer-settings-btn ${n}`,a&&(o.title=a);const l=document.createElementNS("http://www.w3.org/2000/svg","svg");l.setAttribute("xmlns","http://www.w3.org/2000/svg"),l.setAttribute("height","24px"),l.setAttribute("viewBox","0 -960 960 960"),l.setAttribute("width","24px"),l.setAttribute("fill","#1f1f1f"),l.style.marginRight="4px",l.style.verticalAlign="middle",l.innerHTML='<path d="M700-120h40v-100h100v-40H740v-100h-40v100H600v40h100v100Zm20 80q-83 0-141.5-58.5T520-240q0-83 58.5-141.5T720-440q83 0 141.5 58.5T920-240q0 83-58.5 141.5T720-40ZM280-600h400v-80H280v80Zm187 480H200q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v268q-29-14-58.5-21t-61.5-7q-11 0-20.5.5T680-517v-3H280v80h245q-18 17-32.5 37T467-360H280v80h163q-2 10-2.5 19.5T440-240q0 33 6 61.5t21 58.5Z"/>',o.appendChild(l);const s=document.createElement("span");return s.textContent=t,o.appendChild(s),r&&o.addEventListener("click",r),o}({text:"Term Settings",onClick:w,className:r.className,tooltip:"Open WTR Term Settings"}),e.appendChild(t),(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: Settings button created with simple icon system.")}if(e.lastChild!==t&&(e.appendChild(t),(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: Settings button order corrected.")),r&&t){const n="1 1 0%";e.style.display="flex",e.style.gap="5px",r.style.flex=n,t.style.flex=n}};t(),new MutationObserver(()=>{(0,l.Rm)(n.wk.globalSettings,"WTR Term Replacer: Detected change in menu container, ensuring button state."),t()}).observe(e,{childList:!0}),n.wk.observedMenuContainers.add(e)}},330:e=>{"use strict";e.exports=JSON.parse('{"name":"wtr-lab-term-replacer-webpack","version":"5.4.4","description":"A modular, Webpack-powered version of the WTR Lab Term Replacer userscript.","author":"MasuRii","license":"MIT","private":true,"main":"dist/main.js","repository":{"type":"git","url":"https://github.com/MasuRii/wtr-lab-term-replacer-webpack.git"},"bugs":{"url":"https://github.com/MasuRii/wtr-lab-term-replacer-webpack/issues"},"keywords":["term","replacement","wtr-lab","userscript","modular","webpack"],"files":["dist/","src/"],"scripts":{"build":"npm run format && npm run lint:fix && npm run version:update && webpack --mode=production","build:performance":"npm run format && npm run lint:fix && webpack --config webpack.config.js --mode=production","build:greasyfork":"npm run format && npm run lint:fix && webpack --config webpack.config.js --mode=production","build:devbundle":"npm run format && npm run lint:fix && webpack --config webpack.config.js --mode=development","dev":"webpack serve --config webpack.config.js --mode=development","lint":"npm run lint:js && npm run lint:css","lint:check":"npm run lint:js && npm run lint:css","lint:fix":"npm run lint:js:fix && npm run lint:css:fix","lint:js":"eslint src/ --ext .js --max-warnings 0","lint:js:fix":"eslint src/ --ext .js --fix","lint:css":"echo \\"No CSS files found in project\\"","lint:css:fix":"echo \\"No CSS files found in project\\"","format":"prettier --write \\"src/**/*.{js,css}\\"","version:update":"node scripts/update-versions.js update","version:check":"node scripts/update-versions.js version","version:banner":"node scripts/update-versions.js banner","version:header":"node scripts/update-versions.js header"},"devDependencies":{"css-loader":"^7.1.2","eslint":"^9.39.1","eslint-config-prettier":"^10.1.8","eslint-plugin-import":"^2.32.0","eslint-plugin-prettier":"^5.5.4","prettier":"^3.6.2","style-loader":"^4.0.0","stylelint":"^16.25.0","stylelint-prettier":"^5.0.3","stylelint-config-standard":"^39.0.1","webpack":"^5.102.1","webpack-cli":"^6.0.1","webpack-dev-server":"^5.2.2","webpack-userscript":"^3.2.3"}}')},349:(e,t,r)=>{"use strict";r.d(t,{IY:()=>L,Jm:()=>w,Me:()=>b,Qk:()=>x,R6:()=>a.saveTermListLocation,RX:()=>h,VM:()=>u,X:()=>m,az:()=>f,b7:()=>v,fA:()=>p,kF:()=>S,o6:()=>$,ow:()=>y,s3:()=>E,s7:()=>g,ts:()=>R,y$:()=>W,ym:()=>T});var n=r(907),a=r(903),o=r(314),l=r(206),s=r(494),i=r(395),c=r(70),d=r(387);function m(){(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: UI panel hide requested"),(0,o.X)()}function p(e){try{return new RegExp(e),{isValid:!0,error:null}}catch(e){return{isValid:!1,error:e.message}}}async function g(){(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Handle save term started");const e=document.getElementById("wtr-term-id").value,t=document.getElementById("wtr-original"),r=document.getElementById("wtr-replacement"),c=t.value.trim(),d=document.getElementById("wtr-is-regex").checked,m=document.getElementById("wtr-whole-word").checked;if((0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Saving term - original: "${c}", replacement: "${r.value}", isRegex: ${d}, wholeWord: ${m}, caseSensitive: ${document.getElementById("wtr-case-sensitive").checked}`),!c)return void(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Save term failed - empty original text");if(d&&!function(e){try{return new RegExp(e),(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Valid regex pattern: ${e}`),!0}catch(t){return(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Invalid regex pattern: ${e} - ${t.message}`),!1}}(c))return void(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Save term failed - invalid regex pattern");const p={id:e||`term_${Date.now()}`,original:c,replacement:r.value,caseSensitive:document.getElementById("wtr-case-sensitive").checked,isRegex:d,wholeWord:!d&&m},g=n.wk.terms.findIndex(e=>e.id===p.id);g>-1?((0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Updating existing term ${p.id}`),n.wk.terms[g]=p):((0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Adding new term ${p.id}`),n.wk.terms.push(p)),await(0,a.saveTerms)(n.wk.terms),(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Term saved successfully, total terms: ${n.wk.terms.length}`),(0,l.J)(),t.value="",r.value="",document.getElementById("wtr-term-id").value="",document.getElementById("wtr-case-sensitive").checked=!1,document.getElementById("wtr-is-regex").checked=!1,document.getElementById("wtr-whole-word").checked=!1,document.getElementById("wtr-save-btn").textContent="Save Term",(0,o.FP)(n.wk.currentSearchValue),e?((0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Switching to terms tab after update"),(0,o.OG)("terms")):((0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Focusing on original input for next term"),t.focus()),n.wk.isDupMode&&((0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Updating duplicate mode after term change"),(0,s.Cs)())}function u(e){const t=e.target.closest("li")?.dataset.id;if(t&&e.target.classList.contains("wtr-edit-btn")){const e=n.wk.terms.find(e=>e.id===t);e&&(0,o.BD)(e)}}async function w(){(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Delete selected terms started"),(0,o.Xt)();try{const e=[...document.querySelectorAll(".wtr-replacer-term-select:checked")].map(e=>e.dataset.id);if((0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Found ${e.length} terms selected for deletion: ${e.join(", ")}`),0===e.length)return(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Delete cancelled - no terms selected"),void alert("No terms selected.");if(confirm(`Delete ${e.length} term(s)?`)){(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: User confirmed deletion, proceeding...");const t=n.wk.terms.filter(t=>!e.includes(t.id));(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Deleting ${n.wk.terms.length-t.length} terms, ${t.length} remaining`),await(0,a.saveTerms)(t),await(0,a.loadData)(),(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Terms deleted and data reloaded"),(0,l.J)(),n.wk.isDupMode?((0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Updating duplicate mode after deletion"),(0,s.Cs)()):((0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Refreshing term list display"),(0,o.FP)(n.wk.currentSearchValue))}else(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Delete cancelled by user")}catch(e){(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Error during term deletion: ${e.message}`),console.error("Error during term deletion:",e)}finally{(0,o.W4)()}}function b(e){if(!e.target.closest(".chapter-body"))return;const t=window.getSelection().toString().trim(),r=document.querySelector(".wtr-add-term-float-btn");t&&t.length>0&&t.length<100?r.style.display="block":r.style.display="none"}function f(){const e=window.getSelection().toString().trim();e&&((0,o.E1)(),(0,o.BD)(),document.getElementById("wtr-original").value=e,document.getElementById("wtr-replacement").focus()),document.querySelector(".wtr-add-term-float-btn").style.display="none"}function h(e){n.wk.isDupMode||(n.wk.currentSearchValue=e.target.value,n.wk.currentPage=1,(0,o.FP)(n.wk.currentSearchValue),(0,a.saveSearchFieldValue)())}async function R(e){n.wk.settings.isDisabled=e.target.checked,await(0,a.saveSettings)(n.wk.settings);const t=(()=>{const e=window.location.href.match(/(chapter-\d+)/);return e?e[1]:null})();if(!t)return;const r=`#${t} .chapter-body`,o=document.querySelector(r);o&&(n.wk.settings.isDisabled?(0,c.revertAllReplacements)(o):(0,c.performReplacements)(o))}function k(e,t){return new Promise(r=>{const n=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a),r()})}async function v(){k({formatVersion:(0,d.getVersion)(),settings:{[n.wk.novelSlug]:n.wk.settings},terms:{[n.wk.novelSlug]:n.wk.terms}},`${n.wk.novelSlug}-terms.json`)}async function T(){(0,o.Xt)();try{const e=await GM_listValues(),t="wtr_lab_terms_",r="wtr_lab_settings_",n=e.filter(e=>e.startsWith(t)),a=e.filter(e=>e.startsWith(r)),o={formatVersion:(0,d.getVersion)(),settings:{},terms:{}};for(const e of n){const r=e.replace(t,"");o.terms[r]=await GM_getValue(e)}for(const e of a){const t=e.replace(r,"");o.settings[t]=await GM_getValue(e)}k(o,"wtr-lab-all-terms-backup.json")}catch(e){console.error("Error exporting all terms:",e),alert("Failed to export all terms.")}finally{(0,o.W4)()}}async function y(){(0,o.Xt)();try{const e={formatVersion:(0,d.getVersion)(),settings:{[n.wk.novelSlug]:n.wk.settings},terms:{[n.wk.novelSlug]:n.wk.terms}};if(await k(e,`${n.wk.novelSlug}-terms.json`),confirm('The first file (Novel Terms) has been downloaded. Please check if the download completed successfully. Click "OK" to proceed with the second download (All Terms backup), or "Cancel" to skip.')){const e=await GM_listValues(),t="wtr_lab_terms_",r="wtr_lab_settings_",n=e.filter(e=>e.startsWith(t)),a=e.filter(e=>e.startsWith(r)),o={formatVersion:(0,d.getVersion)(),settings:{},terms:{}};for(const e of n){const r=e.replace(t,"");o.terms[r]=await GM_getValue(e)}for(const e of a){const t=e.replace(r,"");o.settings[t]=await GM_getValue(e)}await k(o,"wtr-lab-all-terms-backup.json"),alert("Both files have been successfully exported!")}else alert("Second export cancelled. Only the novel terms file was downloaded.")}catch(e){console.error("Error exporting combined terms:",e),alert("Failed to export combined terms. Please try again.")}finally{(0,o.W4)()}}async function S(e){(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: File import started, import type: ${n.wk.importType}`),(0,o.Xt)();try{const t=e.target.files[0];if(!t)return void(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: No file selected for import");(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Importing file: ${t.name}, size: ${t.size} bytes, type: ${t.type}`);const r=new FileReader;r.onload=async e=>{const t=e.target.result;let r;(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: File content loaded, length: ${t.length} characters`);try{r=JSON.parse(t),(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: JSON parsed successfully")}catch(e){return(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Import failed - invalid JSON: ${e.message}`),void alert("Import failed. Invalid JSON data. Error: "+e.message)}const c=Boolean(r.formatVersion);let d,m;const p=Array.isArray(r),g=!c&&!p&&"object"==typeof r;if((0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Detected format - isNewFormat: ${c}, isArrayData: ${p}, isOldGlobal: ${g}`),p)d={[n.wk.novelSlug]:r},(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Array format detected, mapping to current novel");else if(g)d=r,(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Old global format detected");else{if(!c)return(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Import failed - unrecognized data format"),void alert("Import failed. Unrecognized data format.");d=r.terms||{},m=r.settings||{},(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: New format detected - terms: ${Object.keys(d).length} slugs, settings: ${Object.keys(m).length} slugs`)}let u=Object.keys(d);(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Found data for ${u.length} slugs: ${u.join(", ")}`),"novel"===n.wk.importType&&u.length>1&&((0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Novel import with multiple slugs - warning user"),alert("Warning: File contains data for multiple novels, but importing to current novel only. Use Global Import for all."),d={[n.wk.novelSlug]:d[Object.keys(d)[0]]||[]},m&&(m={[n.wk.novelSlug]:m[Object.keys(m)[0]]||{}}),u=[n.wk.novelSlug]);let w=!1;m&&Object.keys(m).length>0&&((0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Settings detected in import, asking user for confirmation"),w=confirm("This file contains settings. Would you like to import and overwrite your current settings?"));let b=0,f=0,h=0,R=0,k=0;(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Starting term import process...");for(const e of u){(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Processing import for slug: ${e}`);const t=await GM_getValue(`wtr_lab_terms_${e}`,[]);(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Existing terms for ${e}: ${t.length}`);let r=!0;if(t.length>0&&((0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Existing terms found for ${e}, asking user about merge vs overwrite`),r=!confirm(`An existing term list was found for ${e}. Would you like to merge? (OK = Merge, Cancel = Overwrite)`),!r)){if(!confirm("Are you sure you want to overwrite?")){(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: User cancelled overwrite for ${e}`);continue}r=!0}const o=d[e]||[];if((0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Raw terms for ${e}: ${o.length}`),!Array.isArray(o)){(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Skipping ${e} - not an array`);continue}const l=o.filter(e=>{if(e.wholeWord=e.wholeWord??!1,e.isRegex)try{return new RegExp(e.original),k++,!0}catch(t){return R++,(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Skipping invalid regex term: "${e.original}" - ${t.message}`),console.warn(`Skipping invalid regex term on import: "${e.original}"`),!1}return k++,!0});(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Validated terms for ${e}: ${l.length} valid, ${R} invalid`);const{added:s,skipped:c,conflicts:m}=await(0,a.processAndSaveTerms)(e,l,r);b+=s,f+=c,h+=m,(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Import results for ${e} - added: ${s}, skipped: ${c}, conflicts: ${m}`)}w&&((0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Importing settings data..."),await(0,a.processAndSaveSettings)(m)),(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Reloading data and reprocessing chapters..."),await(0,a.loadData)(),(0,l.J)(),(0,o.FP)(n.wk.currentSearchValue),n.wk.isDupMode&&(0,s.Cs)();let v="Import successful!";(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Import completed - totalAdded: ${b}, totalSkipped: ${f}, totalConflicts: ${h}, invalidCount: ${R}, validCount: ${k}`),(b>0||f>0||h>0)&&(v+=`\n${b} new terms added. ${f} duplicates skipped. ${h} conflicts skipped.`),R>0&&(v+=`\n${k} terms imported. ${R} terms skipped due to invalid regex.`),alert(v)},r.readAsText(t),e.target.value="",(0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: File import process initiated")}catch(e){(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Import error: ${e.message}`),alert("An error occurred during import."),console.error(e)}finally{(0,o.W4)()}}function x(e){const t=e.target.dataset.tab;"terms"===document.querySelector(".wtr-replacer-tab-btn.active").dataset.tab&&((0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Saving scroll position before switching from terms to ${t}`),(0,a.saveTermListLocation)()),document.querySelectorAll(".wtr-replacer-tab-btn").forEach(e=>e.classList.remove("active")),e.target.classList.add("active"),document.querySelectorAll(".wtr-replacer-tab-content").forEach(e=>e.classList.remove("active")),document.getElementById(`wtr-tab-${t}`).classList.add("active"),"terms"===t?((0,i.Rm)(n.wk.globalSettings,"WTR Term Replacer: Restoring scroll position after switching to terms tab"),E()):(0,o.kH)()}async function W(){(0,o.Xt)();try{const e=`wtr_lab_terms_${n.wk.novelSlug}`,t=await GM_getValue(e,[]);if((0,s.r_)(t),0===n.wk.dupKeys.length)return void alert("No duplicates found.");n.wk.isDupMode=!0,n.wk.currentDupIndex=0,n.wk.currentSearchValue="",function(){const e=document.getElementById("wtr-search-bar");e&&(e.value="",n.wk.currentSearchValue="",n.wk.currentPage=1,(0,o.FP)(n.wk.currentSearchValue),(0,a.saveSearchFieldValue)())}()}finally{(0,o.W4)()}}async function E(){try{const e=await GM_getValue(`wtr_lab_term_list_location_${n.wk.novelSlug}`,null);e&&(n.wk.savedTermListLocation=e,(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Restoring scroll position - top: ${e.scrollTop}, page: ${e.page}`)),n.wk.currentPage=n.wk.savedTermListLocation.page||1,n.wk.currentSearchValue=n.wk.savedTermListLocation.searchValue||"";const t=document.getElementById("wtr-search-bar");t&&n.wk.currentSearchValue&&(t.value=n.wk.currentSearchValue),(0,o.FP)(n.wk.currentSearchValue),setTimeout(()=>{const e=document.querySelector(".wtr-replacer-content");e&&n.wk.savedTermListLocation.scrollTop&&(e.scrollTop=n.wk.savedTermListLocation.scrollTop,(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Scroll position restored to ${n.wk.savedTermListLocation.scrollTop}`))},100)}catch(e){console.error("Error restoring term list location:",e)}}function $(){n.wk.globalSettings.isLoggingEnabled=!n.wk.globalSettings.isLoggingEnabled,(0,a.saveGlobalSettings)(),alert(`Logging ${n.wk.globalSettings.isLoggingEnabled?"enabled":"disabled"}.`)}async function L(e,t,r=!1){if(!e)return;const l={id:`term_${Date.now()}`,original:e.trim(),replacement:t.trim(),caseSensitive:!1,isRegex:r,wholeWord:!1};n.wk.terms.some(e=>e.original===l.original&&e.replacement===l.replacement&&e.isRegex===l.isRegex)?(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Skipped adding duplicate term: ${l.original}`):(n.wk.terms.push(l),await(0,a.saveTerms)(n.wk.terms),(0,i.Rm)(n.wk.globalSettings,`WTR Term Replacer: Programmatically added term (Regex: ${r}): ${l.original} -> ${l.replacement}`),"flex"===document.querySelector(".wtr-replacer-ui").style.display&&(0,o.FP)(n.wk.currentSearchValue))}},387:(e,t,r)=>{const n={}.WTR_VERSION||{}.APP_VERSION,a={}.WTR_BUILD_ENV||{}.BUILD_ENV||"production",o={}.WTR_BUILD_DATE||{}.BUILD_DATE||(new Date).toISOString().split("T")[0],l=r(330).version,s={SEMANTIC:n||l,DISPLAY:`v${n||l}`,BUILD_ENV:a||"production",BUILD_DATE:o,GREASYFORK:n||l,NPM:n||l,BADGE:n||l,CHANGELOG:n||l};e.exports={VERSION_INFO:s,getVersion:(e="semantic")=>{switch(e.toLowerCase()){case"semantic":case"semver":default:return s.SEMANTIC;case"display":return s.DISPLAY;case"build":return`${s.SEMANTIC}-${s.BUILD_ENV}`;case"dev":return`${s.SEMANTIC}-dev.${Date.now()}`}},getBuildTime:()=>(new Date).toISOString(),getBuildDate:()=>s.BUILD_DATE,isProduction:()=>"production"===s.BUILD_ENV,isDevelopment:()=>"development"===s.BUILD_ENV,getDisplayVersion:()=>s.DISPLAY}},395:(e,t,r)=>{"use strict";function n(){let e=window.location.pathname.match(/novel\/\d+\/([^/]+)/);return e?e[1]:(e=window.location.pathname.match(/serie-\d+\/([^/]+)/),e?e[1]:null)}function a(e){return e.replace(/[.*+?^${}()|[\]\\/]/g,"\\$&")}function o(e){const t=e.match(/(chapter-\d+)/);return t?t[1]:null}function l(e,...t){e&&e.isLoggingEnabled&&console.log(...t)}r.d(t,{Nt:()=>a,Rm:()=>l,Ug:()=>o,getNovelSlug:()=>n}),(0,r(387).getVersion)()},494:(e,t,r)=>{"use strict";r.d(t,{Cs:()=>i,DP:()=>s,bj:()=>l,r_:()=>o});var n=r(907),a=r(314);function o(e){const t=new Map,r=new Map,a=new Map;e.forEach(e=>{const n=function(e){const t=[],r=e.original;return e.isRegex&&!/[\\^$.*+?()[\]{}()]/.test(r)?t.push(...r.split("|")):t.push(r),t.map(t=>{let r=t.trim().replace(/\s+/g," ");return e.caseSensitive||(r=r.toLowerCase()),r}).filter(e=>e.length>0)}(e);if(n.length>1&&new Set(n).size<n.length){const t=`Internal duplicate in: "${e.original.length>50?e.original.substring(0,47)+"...":e.original}"`;a.set(t,[e])}if(n.forEach(r=>{t.has(r)||t.set(r,[]);const n=t.get(r);n.some(t=>t.id===e.id)||n.push(e)}),e.replacement){const t=e.replacement;r.has(t)||r.set(t,[]),r.get(t).push(e)}});for(const[e,r]of t.entries())r.length>1&&a.set(`Original component: "${e}"`,r);for(const[e,t]of r.entries())if(t.length>1){const r=`Replacement: "${e}"`;if(a.has(r)){const e=a.get(r),n=t.filter(t=>!e.some(e=>e.id===t.id));a.set(r,[...e,...n])}else a.set(r,t)}n.wk.dupGroups=a,n.wk.dupKeys=Array.from(n.wk.dupGroups.keys()).sort()}function l(){n.wk.isDupMode=!1,n.wk.currentDupIndex=0,n.wk.dupGroups=new Map,n.wk.dupKeys=[],(0,a.FP)(n.wk.currentSearchValue)}function s(e){n.wk.currentDupIndex=Math.max(0,Math.min(n.wk.dupKeys.length-1,n.wk.currentDupIndex+e)),(0,a.FP)()}function i(){if(o(n.wk.terms),0===n.wk.dupKeys.length)return alert("All duplicates resolved."),void l();const e=n.wk.dupKeys[n.wk.currentDupIndex],t=n.wk.dupKeys.indexOf(e);if(-1!==t){const r=n.wk.dupGroups.get(e);r&&(r.length>1||e.startsWith("Internal duplicate"))?n.wk.currentDupIndex=t:n.wk.currentDupIndex=Math.min(n.wk.currentDupIndex,n.wk.dupKeys.length-1)}else n.wk.currentDupIndex=Math.min(n.wk.currentDupIndex,n.wk.dupKeys.length-1);(0,a.FP)()}},903:(e,t,r)=>{"use strict";r.r(t),r.d(t,{getTermKey:()=>u,loadData:()=>m,loadGlobalSettings:()=>l,loadTermListLocation:()=>i,processAndSaveSettings:()=>b,processAndSaveTerms:()=>w,saveGlobalSettings:()=>s,saveSearchFieldValue:()=>d,saveSettings:()=>g,saveTermListLocation:()=>c,saveTerms:()=>p});var n=r(907),a=r(194),o=r(395);async function l(){try{n.wk.globalSettings=await GM_getValue(a.sI,{isLoggingEnabled:!1}),(0,o.Rm)(n.wk.globalSettings,"WTR Term Replacer: Global settings loaded")}catch(e){console.error("Error loading global settings:",e),n.wk.globalSettings={isLoggingEnabled:!1}}}async function s(){try{await GM_setValue(a.sI,n.wk.globalSettings),(0,o.Rm)(n.wk.globalSettings,"WTR Term Replacer: Global settings saved")}catch(e){console.error("Error saving global settings:",e)}}async function i(){try{const e=await GM_getValue(`${a.Qp}_${n.wk.novelSlug}`,null);e&&(n.wk.savedTermListLocation=e)}catch(e){console.error("Error loading term list location:",e),n.wk.savedTermListLocation={page:1,scrollTop:0,searchValue:""}}}async function c(){try{const e=document.querySelector(".wtr-replacer-content");if(e){const t={page:n.wk.currentPage,scrollTop:e.scrollTop,scrollHeight:e.scrollHeight,clientHeight:e.clientHeight,searchValue:n.wk.currentSearchValue,timestamp:Date.now()};await GM_setValue(`${a.Qp}_${n.wk.novelSlug}`,t),n.wk.savedTermListLocation=t,(0,o.Rm)(n.wk.globalSettings,`WTR Term Replacer: Saved scroll position - top: ${t.scrollTop}, page: ${t.page}`)}}catch(e){console.error("Error saving term list location:",e)}}async function d(){try{const e={page:n.wk.currentPage,scrollTop:0,searchValue:n.wk.currentSearchValue};await GM_setValue(`${a.Qp}_${n.wk.novelSlug}`,e),n.wk.savedTermListLocation=e}catch(e){console.error("Error saving search field value:",e)}}async function m(){try{const e=`${a.fW}${n.wk.novelSlug}`,t=`${a.Ft}${n.wk.novelSlug}`;n.wk.terms=await GM_getValue(e,[]),n.wk.terms.forEach(e=>{e.wholeWord=e.wholeWord??!1});const r=await GM_getValue(t,{});n.wk.settings={isDisabled:!1,...r}}catch(e){console.error("Error loading data:",e),n.wk.terms=[],n.wk.settings={isDisabled:!1}}}async function p(e){try{const t=`${a.fW}${n.wk.novelSlug}`;await GM_setValue(t,e),n.wk.terms=e,(0,o.Rm)(n.wk.globalSettings,`WTR Term Replacer: Saved ${e.length} terms for novel ${n.wk.novelSlug}`)}catch(e){console.error("Error saving terms:",e),(0,o.Rm)(n.wk.globalSettings,`WTR Term Replacer: Failed to save terms: ${e.message}`),alert("Failed to save terms. Storage might be full.")}}async function g(e){try{const t=`${a.Ft}${n.wk.novelSlug}`;await GM_setValue(t,e),n.wk.settings=e,(0,o.Rm)(n.wk.globalSettings,"WTR Term Replacer: Settings saved successfully")}catch(e){console.error("Error saving settings:",e),(0,o.Rm)(n.wk.globalSettings,`WTR Term Replacer: Failed to save settings: ${e.message}`),alert("Failed to save settings. Storage might be full.")}}function u(e){return`${e.original}|${e.caseSensitive}|${e.isRegex}`}async function w(e,t,r=!0){(0,o.Rm)(n.wk.globalSettings,`WTR Term Replacer: Processing import for slug ${e}, overwrite: ${r}`);const l=`${a.fW}${e}`,s=await GM_getValue(l,[]);s.forEach(e=>{e.wholeWord=e.wholeWord??!1});let i=[],c=0,d=0,m=0;if(r)(0,o.Rm)(n.wk.globalSettings,`WTR Term Replacer: Overwrite mode - importing ${t.length} terms`),i=t;else{const e=new Map;s.forEach(t=>e.set(u(t),t)),t.forEach(t=>{const r=u(t);if(e.has(r)){const n=e.get(r);n.replacement!==t.replacement||n.wholeWord!==t.wholeWord?m++:d++}else i.push(t),c++}),i=[...s,...i],(0,o.Rm)(n.wk.globalSettings,`WTR Term Replacer: Merge mode - added: ${c}, skipped: ${d}, conflicts: ${m}`)}return await GM_setValue(l,i),e===n.wk.novelSlug&&(n.wk.terms=i),(0,o.Rm)(n.wk.globalSettings,`WTR Term Replacer: Import complete for ${e} - total terms: ${i.length}`),{added:c,skipped:d,conflicts:m}}async function b(e){(0,o.Rm)(n.wk.globalSettings,`WTR Term Replacer: Processing settings import for ${Object.keys(e).length} slugs`);for(const t in e){const r=`${a.Ft}${t}`,l={...await GM_getValue(r,{isDisabled:!1}),...e[t]};await GM_setValue(r,l),t===n.wk.novelSlug&&(n.wk.settings=l),(0,o.Rm)(n.wk.globalSettings,`WTR Term Replacer: Settings updated for slug ${t}`)}}},907:(e,t,r)=>{"use strict";r.d(t,{oP:()=>a,wk:()=>n});const n={novelSlug:null,terms:[],settings:{isDisabled:!1},globalSettings:{isLoggingEnabled:!1},importType:"novel",currentSearchValue:"",isDupMode:!1,dupGroups:new Map,dupKeys:[],currentDupIndex:0,currentPage:1,savedTermListLocation:{page:1,scrollTop:0,searchValue:""},originalTextNodes:new WeakMap,otherWTRScripts:new Set,processingStartTime:new Map,domConflictDetected:!1,multiScriptPerformanceImpact:new Map,currentURL:window.location.href,processingQueue:new Set,isProcessingInProgress:!1,observedMenuContainers:new WeakSet};function a(e){n.novelSlug=e}}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,r),o.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";var e=r(314),t=r(903),n=r(206),a=r(907),o=r(349),l=r(395);(async function(){(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Main function starting initialization...");const s=(0,l.getNovelSlug)();if(!s)return(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Critical error - could not determine novel slug"),void console.error("WTR Term Replacer: Could not determine novel slug.");(0,l.Rm)(a.wk.globalSettings,`WTR Term Replacer: Novel slug determined: ${s}`),(0,a.oP)(s),(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Loading global settings and data..."),await(0,t.loadGlobalSettings)(),await(0,t.loadData)(),(0,l.Rm)(a.wk.globalSettings,`WTR Term Replacer: Data loaded - terms: ${a.wk.terms.length}, settings disabled: ${a.wk.settings.isDisabled}`),(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Setting up error handling..."),window.addEventListener("error",e=>{e.error&&e.error.message&&e.error.message.includes("WTR")&&(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Caught error:",e.error)}),window.addEventListener("unhandledrejection",e=>{e.reason&&e.reason.message&&e.reason.message.includes("WTR")&&(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Unhandled promise rejection:",e.reason)}),window.addEventListener("beforeunload",()=>{a.wk.processingQueue.clear(),(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Cleanup on page unload")}),(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Enhanced error handling activated"),(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Setting up disable functionality..."),function(){const e=async function(e){const t=a.wk.settings.isDisabled,n=e.target.checked;a.wk.settings.isDisabled=n,await(await Promise.resolve().then(r.bind(r,903))).saveSettings(a.wk.settings);const o=function(){const e=window.location.href.match(/(chapter-\d+)/);return e?e[1]:null}();if(!o)return;const s=`#${o} .chapter-body`,i=document.querySelector(s);if(i)try{const{performReplacements:e,revertAllReplacements:t}=await Promise.resolve().then(r.bind(r,70));n?((0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Robust disable - reverting all replacements"),await t(i),i.dataset.wtrProcessed="false"):((0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Robust enable - performing replacements"),await e(i),i.dataset.wtrProcessed="true")}catch(r){(0,l.Rm)(a.wk.globalSettings,`WTR Term Replacer: Error during ${n?"disable":"enable"} operation:`,r),e.target.checked=t,a.wk.settings.isDisabled=t}},t=document.querySelector(".wtr-replacer-ui");if(t){const r=t.querySelector("#wtr-disable-all");if(r){const t=r.cloneNode(!0);r.parentNode.replaceChild(t,r),t.addEventListener("change",e)}}(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Enhanced disable functionality activated")}(),(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Setting up navigation handling..."),function(){let e=!1;const t=()=>{e?(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Navigation already in progress, skipping"):(e=!0,a.wk.processingQueue.clear(),setTimeout(()=>{Promise.resolve().then(r.bind(r,206)).then(({processVisibleChapter:e})=>{e()}),e=!1},500))};window.addEventListener("popstate",()=>{(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Popstate event detected"),t()});const n=history.pushState,o=history.replaceState;history.pushState=function(...e){const r=n.apply(this,e);return t(),r},history.replaceState=function(...e){const r=o.apply(this,e);return t(),r},(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Enhanced navigation handling activated")}(),(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Creating UI and menu commands..."),(0,e.RD)(),(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Registering menu commands..."),GM_registerMenuCommand("Term Replacer Settings",e.E1),GM_registerMenuCommand("Toggle Logging",o.o6),(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Starting initial content detection..."),(0,n._)(),(0,l.Rm)(a.wk.globalSettings,"WTR Term Replacer: Initialization completed successfully")})().catch(e=>console.error("WTR Term Replacer failed to start:",e)),window.addEventListener("wtr:addTerm",e=>{const{original:t,replacement:r,isRegex:n}=e.detail;o.IY(t,r,n)})})()})();